// koffee 1.12.0

/*
0000000    000  00000000    0000000   0000000    0000000  000   000  00000000
000   000  000  000   000  000       000   000  000       000   000  000     
000   000  000  0000000    000       000000000  000       000000000  0000000 
000   000  000  000   000  000       000   000  000       000   000  000     
0000000    000  000   000   0000000  000   000   0000000  000   000  00000000
 */
var DirCache, _, post, ref, watch;

ref = require('kxk'), _ = ref._, post = ref.post, watch = ref.watch;

DirCache = (function() {
    function DirCache() {}

    DirCache.cache = {};

    DirCache.watches = {};

    DirCache.has = function(dir) {
        return DirCache.cache[dir] != null;
    };

    DirCache.get = function(dir) {
        return DirCache.cache[dir];
    };

    DirCache.set = function(dir, items) {
        DirCache.watch(dir);
        return DirCache.cache[dir] = _.clone(items);
    };

    DirCache.reset = function() {
        var dir, i, len, ref1, results;
        ref1 = Object.keys(DirCache.cache);
        results = [];
        for (i = 0, len = ref1.length; i < len; i++) {
            dir = ref1[i];
            results.push(DirCache.unwatch(dir));
        }
        return results;
    };

    DirCache.watch = function(dir) {
        var watcher;
        if (DirCache.watches[dir]) {
            return;
        }
        watcher = watch.dir(dir);
        watcher.on('change', DirCache.onChange);
        watcher.on('error', function(err) {
            return console.error("watch.error " + err);
        });
        return DirCache.watches[dir] = watcher;
    };

    DirCache.unwatch = function(dir) {
        var ref1;
        if ((ref1 = DirCache.watches[dir]) != null) {
            ref1.close();
        }
        delete DirCache.watches[dir];
        delete DirCache.cache[dir];
        return post.emit('dircache', dir);
    };

    DirCache.onChange = function(info) {
        var dir;
        dir = info.dir;
        if (DirCache.cache[dir]) {
            return DirCache.unwatch(dir);
        }
    };

    return DirCache;

})();

module.exports = DirCache;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlyY2FjaGUuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vY29mZmVlL3Rvb2xzIiwic291cmNlcyI6WyJkaXJjYWNoZS5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7OztBQUFBLElBQUE7O0FBUUEsTUFBcUIsT0FBQSxDQUFRLEtBQVIsQ0FBckIsRUFBRSxTQUFGLEVBQUssZUFBTCxFQUFXOztBQUVMOzs7SUFFRixRQUFDLENBQUEsS0FBRCxHQUFXOztJQUNYLFFBQUMsQ0FBQSxPQUFELEdBQVc7O0lBRVgsUUFBQyxDQUFBLEdBQUQsR0FBTSxTQUFDLEdBQUQ7ZUFBUztJQUFUOztJQUNOLFFBQUMsQ0FBQSxHQUFELEdBQU0sU0FBQyxHQUFEO2VBQVMsUUFBUSxDQUFDLEtBQU0sQ0FBQSxHQUFBO0lBQXhCOztJQUNOLFFBQUMsQ0FBQSxHQUFELEdBQU0sU0FBQyxHQUFELEVBQU0sS0FBTjtRQUVGLFFBQVEsQ0FBQyxLQUFULENBQWUsR0FBZjtlQUNBLFFBQVEsQ0FBQyxLQUFNLENBQUEsR0FBQSxDQUFmLEdBQXNCLENBQUMsQ0FBQyxLQUFGLENBQVEsS0FBUjtJQUhwQjs7SUFLTixRQUFDLENBQUEsS0FBRCxHQUFRLFNBQUE7QUFFSixZQUFBO0FBQUE7QUFBQTthQUFBLHNDQUFBOzt5QkFDSSxRQUFRLENBQUMsT0FBVCxDQUFpQixHQUFqQjtBQURKOztJQUZJOztJQUtSLFFBQUMsQ0FBQSxLQUFELEdBQVEsU0FBQyxHQUFEO0FBRUosWUFBQTtRQUFBLElBQVUsUUFBUSxDQUFDLE9BQVEsQ0FBQSxHQUFBLENBQTNCO0FBQUEsbUJBQUE7O1FBRUEsT0FBQSxHQUFVLEtBQUssQ0FBQyxHQUFOLENBQVUsR0FBVjtRQUNWLE9BQU8sQ0FBQyxFQUFSLENBQVcsUUFBWCxFQUFvQixRQUFRLENBQUMsUUFBN0I7UUFDQSxPQUFPLENBQUMsRUFBUixDQUFXLE9BQVgsRUFBbUIsU0FBQyxHQUFEO21CQUFPLE9BQUEsQ0FBRSxLQUFGLENBQVEsY0FBQSxHQUFlLEdBQXZCO1FBQVAsQ0FBbkI7ZUFDQSxRQUFRLENBQUMsT0FBUSxDQUFBLEdBQUEsQ0FBakIsR0FBd0I7SUFQcEI7O0lBU1IsUUFBQyxDQUFBLE9BQUQsR0FBVSxTQUFDLEdBQUQ7QUFFTixZQUFBOztnQkFBcUIsQ0FBRSxLQUF2QixDQUFBOztRQUVBLE9BQU8sUUFBUSxDQUFDLE9BQVEsQ0FBQSxHQUFBO1FBQ3hCLE9BQU8sUUFBUSxDQUFDLEtBQU0sQ0FBQSxHQUFBO2VBRXRCLElBQUksQ0FBQyxJQUFMLENBQVUsVUFBVixFQUFxQixHQUFyQjtJQVBNOztJQVNWLFFBQUMsQ0FBQSxRQUFELEdBQVcsU0FBQyxJQUFEO0FBRVAsWUFBQTtRQUFBLEdBQUEsR0FBTSxJQUFJLENBQUM7UUFFWCxJQUFHLFFBQVEsQ0FBQyxLQUFNLENBQUEsR0FBQSxDQUFsQjttQkFDSSxRQUFRLENBQUMsT0FBVCxDQUFpQixHQUFqQixFQURKOztJQUpPOzs7Ozs7QUFPZixNQUFNLENBQUMsT0FBUCxHQUFpQiIsInNvdXJjZXNDb250ZW50IjpbIiMjI1xuMDAwMDAwMCAgICAwMDAgIDAwMDAwMDAwICAgIDAwMDAwMDAgICAwMDAwMDAwICAgIDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDBcbjAwMCAgIDAwMCAgMDAwICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgICAgXG4wMDAgICAwMDAgIDAwMCAgMDAwMDAwMCAgICAwMDAgICAgICAgMDAwMDAwMDAwICAwMDAgICAgICAgMDAwMDAwMDAwICAwMDAwMDAwIFxuMDAwICAgMDAwICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgICBcbjAwMDAwMDAgICAgMDAwICAwMDAgICAwMDAgICAwMDAwMDAwICAwMDAgICAwMDAgICAwMDAwMDAwICAwMDAgICAwMDAgIDAwMDAwMDAwXG4jIyNcblxueyBfLCBwb3N0LCB3YXRjaCB9ID0gcmVxdWlyZSAna3hrJ1xuXG5jbGFzcyBEaXJDYWNoZVxuXG4gICAgQGNhY2hlICAgPSB7fVxuICAgIEB3YXRjaGVzID0ge31cbiAgICBcbiAgICBAaGFzOiAoZGlyKSAtPiBEaXJDYWNoZS5jYWNoZVtkaXJdP1xuICAgIEBnZXQ6IChkaXIpIC0+IERpckNhY2hlLmNhY2hlW2Rpcl1cbiAgICBAc2V0OiAoZGlyLCBpdGVtcykgLT4gXG4gICAgXG4gICAgICAgIERpckNhY2hlLndhdGNoIGRpclxuICAgICAgICBEaXJDYWNoZS5jYWNoZVtkaXJdID0gXy5jbG9uZSBpdGVtc1xuICAgICAgICBcbiAgICBAcmVzZXQ6IC0+XG4gICAgICAgIFxuICAgICAgICBmb3IgZGlyIGluIE9iamVjdC5rZXlzIERpckNhY2hlLmNhY2hlXG4gICAgICAgICAgICBEaXJDYWNoZS51bndhdGNoIGRpclxuICAgIFxuICAgIEB3YXRjaDogKGRpcikgLT5cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBpZiBEaXJDYWNoZS53YXRjaGVzW2Rpcl1cbiAgICAgICAgXG4gICAgICAgIHdhdGNoZXIgPSB3YXRjaC5kaXIgZGlyXG4gICAgICAgIHdhdGNoZXIub24gJ2NoYW5nZScgRGlyQ2FjaGUub25DaGFuZ2VcbiAgICAgICAgd2F0Y2hlci5vbiAnZXJyb3InIChlcnIpIC0+IGVycm9yIFwid2F0Y2guZXJyb3IgI3tlcnJ9XCJcbiAgICAgICAgRGlyQ2FjaGUud2F0Y2hlc1tkaXJdID0gd2F0Y2hlclxuICAgICAgICBcbiAgICBAdW53YXRjaDogKGRpcikgLT4gXG4gICAgICAgIFxuICAgICAgICBEaXJDYWNoZS53YXRjaGVzW2Rpcl0/LmNsb3NlKClcbiAgICAgICAgICAgIFxuICAgICAgICBkZWxldGUgRGlyQ2FjaGUud2F0Y2hlc1tkaXJdXG4gICAgICAgIGRlbGV0ZSBEaXJDYWNoZS5jYWNoZVtkaXJdXG4gICAgICAgIFxuICAgICAgICBwb3N0LmVtaXQgJ2RpcmNhY2hlJyBkaXJcblxuICAgIEBvbkNoYW5nZTogKGluZm8pIC0+XG5cbiAgICAgICAgZGlyID0gaW5mby5kaXJcblxuICAgICAgICBpZiBEaXJDYWNoZS5jYWNoZVtkaXJdXG4gICAgICAgICAgICBEaXJDYWNoZS51bndhdGNoIGRpclxuICAgICAgICAgICAgXG5tb2R1bGUuZXhwb3J0cyA9IERpckNhY2hlXG4iXX0=
//# sourceURL=../../coffee/tools/dircache.coffee