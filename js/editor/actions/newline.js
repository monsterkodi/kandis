// koffee 1.7.0

/*
000   000  00000000  000   000  000      000  000   000  00000000
0000  000  000       000 0 000  000      000  0000  000  000     
000 0 000  0000000   000000000  000      000  000 0 000  0000000 
000  0000  000       000   000  000      000  000  0000  000     
000   000  00000000  00     00  0000000  000  000   000  00000000
 */
var _, klog, last, ref;

ref = require('kxk'), _ = ref._, klog = ref.klog, last = ref.last;

module.exports = {
    actions: {
        menu: 'Line',
        newline: {
            name: 'Insert Newline',
            combos: ['enter']
        },
        newlineAtEnd: {
            name: 'Insert Newline at End',
            combo: 'alt+enter'
        }
    },
    newlineAtEnd: function() {
        this.moveCursorsToLineBoundary('right');
        return this.newline({
            indent: true
        });
    },
    newline: function(key, info) {
        var after, before, bl, c, doIndent, i, indent, j, len, len1, nc, newCursors, ref1, ref2, ref3, ref4, ref5;
        if ((info == null) && _.isObject(key)) {
            info = key;
        }
        if (this.salterMode) {
            klog('newline endSalter');
            this.endSalter();
            this.singleCursorAtPos(last(this.cursors()));
            klog('newline cursors', this.cursors());
            this.newlineAtEnd();
            return;
        }
        doIndent = (ref1 = info != null ? info.indent : void 0) != null ? ref1 : !this.isCursorInIndent();
        this.surroundStack = [];
        this.deleteSelection();
        this["do"].start();
        if (this.salterMode) {
            newCursors = [rangeEndPos(this.rangeForLineAtIndex(this.mainCursor()[1]))];
            this.setSalterMode(false);
        } else {
            newCursors = this["do"].cursors();
        }
        ref2 = this["do"].cursors().reverse();
        for (i = 0, len = ref2.length; i < len; i++) {
            c = ref2[i];
            ref3 = this.splitStateLineAtPos(this["do"], c), before = ref3[0], after = ref3[1];
            if (doIndent) {
                after = after.trimLeft();
            }
            if (doIndent) {
                indent = this.indentStringForLineAtIndex(c[1]);
                if ((ref4 = this.fileType) === 'coffee' || ref4 === 'koffee') {
                    if (/(when|if)/.test(before)) {
                        if (after.startsWith('then ')) {
                            after = after.slice(4).trimLeft();
                            indent += this.indentString;
                        } else if (before.trim().endsWith('then')) {
                            before = before.trimRight();
                            before = before.slice(0, before.length - 4);
                            indent += this.indentString;
                        }
                    }
                }
            } else {
                if (c[0] <= indentationInLine(this["do"].line(c[1]))) {
                    indent = this["do"].line(c[1]).slice(0, c[0]);
                } else {
                    indent = '';
                }
            }
            bl = c[0];
            if (c[0] >= this["do"].line(c[1]).length) {
                this["do"].insert(c[1] + 1, indent);
            } else {
                this["do"].insert(c[1] + 1, indent + after);
                if ((this.insertIndentedEmptyLineBetween != null) && before.trimRight().endsWith(this.insertIndentedEmptyLineBetween[0] && after.trimLeft().startsWith(this.insertIndentedEmptyLineBetween[1]))) {
                    indent += this.indentString;
                    this["do"].insert(c[1] + 1, indent);
                }
                this["do"].change(c[1], before);
            }
            ref5 = positionsFromPosInPositions(c, newCursors);
            for (j = 0, len1 = ref5.length; j < len1; j++) {
                nc = ref5[j];
                cursorDelta(nc, nc[1] === c[1] && indent.length - bl || 0, 1);
            }
        }
        this["do"].setCursors(newCursors);
        return this["do"].end();
    }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmV3bGluZS5qcyIsInNvdXJjZVJvb3QiOiIuIiwic291cmNlcyI6WyIiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7OztBQUFBLElBQUE7O0FBUUEsTUFBb0IsT0FBQSxDQUFRLEtBQVIsQ0FBcEIsRUFBRSxTQUFGLEVBQUssZUFBTCxFQUFXOztBQUVYLE1BQU0sQ0FBQyxPQUFQLEdBRUk7SUFBQSxPQUFBLEVBQ0k7UUFBQSxJQUFBLEVBQU0sTUFBTjtRQUVBLE9BQUEsRUFDSTtZQUFBLElBQUEsRUFBTSxnQkFBTjtZQUNBLE1BQUEsRUFBUSxDQUFDLE9BQUQsQ0FEUjtTQUhKO1FBTUEsWUFBQSxFQUNJO1lBQUEsSUFBQSxFQUFPLHVCQUFQO1lBQ0EsS0FBQSxFQUFPLFdBRFA7U0FQSjtLQURKO0lBV0EsWUFBQSxFQUFjLFNBQUE7UUFFVixJQUFDLENBQUEseUJBQUQsQ0FBMkIsT0FBM0I7ZUFDQSxJQUFDLENBQUEsT0FBRCxDQUFTO1lBQUEsTUFBQSxFQUFRLElBQVI7U0FBVDtJQUhVLENBWGQ7SUFnQkEsT0FBQSxFQUFTLFNBQUMsR0FBRCxFQUFNLElBQU47QUFFTCxZQUFBO1FBQUEsSUFBTyxjQUFKLElBQWMsQ0FBQyxDQUFDLFFBQUYsQ0FBVyxHQUFYLENBQWpCO1lBQ0ksSUFBQSxHQUFPLElBRFg7O1FBR0EsSUFBRyxJQUFDLENBQUEsVUFBSjtZQUNJLElBQUEsQ0FBSyxtQkFBTDtZQUNBLElBQUMsQ0FBQSxTQUFELENBQUE7WUFDQSxJQUFDLENBQUEsaUJBQUQsQ0FBbUIsSUFBQSxDQUFLLElBQUMsQ0FBQSxPQUFELENBQUEsQ0FBTCxDQUFuQjtZQUNBLElBQUEsQ0FBSyxpQkFBTCxFQUF1QixJQUFDLENBQUEsT0FBRCxDQUFBLENBQXZCO1lBQ0EsSUFBQyxDQUFBLFlBQUQsQ0FBQTtBQUNBLG1CQU5KOztRQVFBLFFBQUEsaUVBQTBCLENBQUksSUFBQyxDQUFBLGdCQUFELENBQUE7UUFFOUIsSUFBQyxDQUFBLGFBQUQsR0FBaUI7UUFD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LENBREosQ0FESjtvQkFHWSxNQUFBLElBQVUsSUFBQyxDQUFBO29CQUNYLElBQUMsRUFBQSxFQUFBLEVBQUUsQ0FBQyxNQUFKLENBQVcsQ0FBRSxDQUFBLENBQUEsQ0FBRixHQUFLLENBQWhCLEVBQW1CLE1BQW5CLEVBSlo7O2dCQUtBLElBQUMsRUFBQSxFQUFBLEVBQUUsQ0FBQyxNQUFKLENBQVcsQ0FBRSxDQUFBLENBQUEsQ0FBYixFQUFpQixNQUFqQixFQVRKOztBQVlBO0FBQUEsaUJBQUEsd0NBQUE7O2dCQUNJLFdBQUEsQ0FBWSxFQUFaLEVBQWdCLEVBQUcsQ0FBQSxDQUFBLENBQUgsS0FBUyxDQUFFLENBQUEsQ0FBQSxDQUFYLElBQWtCLE1BQU0sQ0FBQyxNQUFQLEdBQWdCLEVBQWxDLElBQXdDLENBQXhELEVBQTJELENBQTNEO0FBREo7QUF0Q0o7UUF5Q0EsSUFBQyxFQUFBLEVBQUEsRUFBRSxDQUFDLFVBQUosQ0FBZSxVQUFmO2VBQ0EsSUFBQyxFQUFBLEVBQUEsRUFBRSxDQUFDLEdBQUosQ0FBQTtJQW5FSyxDQWhCVCIsInNvdXJjZXNDb250ZW50IjpbIiMjI1xuMDAwICAgMDAwICAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDBcbjAwMDAgIDAwMCAgMDAwICAgICAgIDAwMCAwIDAwMCAgMDAwICAgICAgMDAwICAwMDAwICAwMDAgIDAwMCAgICAgXG4wMDAgMCAwMDAgIDAwMDAwMDAgICAwMDAwMDAwMDAgIDAwMCAgICAgIDAwMCAgMDAwIDAgMDAwICAwMDAwMDAwIFxuMDAwICAwMDAwICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgIDAwMCAgMDAwMCAgMDAwICAgICBcbjAwMCAgIDAwMCAgMDAwMDAwMDAgIDAwICAgICAwMCAgMDAwMDAwMCAgMDAwICAwMDAgICAwMDAgIDAwMDAwMDAwXG4jIyNcblxueyBfLCBrbG9nLCBsYXN0IH0gPSByZXF1aXJlICdreGsnXG5cbm1vZHVsZS5leHBvcnRzID0gXG4gICAgXG4gICAgYWN0aW9uczpcbiAgICAgICAgbWVudTogJ0xpbmUnXG4gICAgICAgIFxuICAgICAgICBuZXdsaW5lOlxuICAgICAgICAgICAgbmFtZTogJ0luc2VydCBOZXdsaW5lJ1xuICAgICAgICAgICAgY29tYm9zOiBbJ2VudGVyJ11cbiAgICAgICAgICAgIFxuICAgICAgICBuZXdsaW5lQXRFbmQ6XG4gICAgICAgICAgICBuYW1lOiAgJ0luc2VydCBOZXdsaW5lIGF0IEVuZCdcbiAgICAgICAgICAgIGNvbWJvOiAnYWx0K2VudGVyJ1xuXG4gICAgbmV3bGluZUF0RW5kOiAoKSAtPlxuICAgICAgICBcbiAgICAgICAgQG1vdmVDdXJzb3JzVG9MaW5lQm91bmRhcnkgJ3JpZ2h0JyAgXG4gICAgICAgIEBuZXdsaW5lIGluZGVudDogdHJ1ZVxuXG4gICAgbmV3bGluZTogKGtleSwgaW5mbykgLT5cbiAgICAgICAgXG4gICAgICAgIGlmIG5vdCBpbmZvPyBhbmQgXy5pc09iamVjdCBrZXlcbiAgICAgICAgICAgIGluZm8gPSBrZXlcblxuICAgICAgICBpZiBAc2FsdGVyTW9kZVxuICAgICAgICAgICAga2xvZyAnbmV3bGluZSBlbmRTYWx0ZXInXG4gICAgICAgICAgICBAZW5kU2FsdGVyKClcbiAgICAgICAgICAgIEBzaW5nbGVDdXJzb3JBdFBvcyBsYXN0IEBjdXJzb3JzKClcbiAgICAgICAgICAgIGtsb2cgJ25ld2xpbmUgY3Vyc29ycycgQGN1cnNvcnMoKVxuICAgICAgICAgICAgQG5ld2xpbmVBdEVuZCgpXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgXG4gICAgICAgIGRvSW5kZW50ID0gaW5mbz8uaW5kZW50ID8gbm90IEBpc0N1cnNvckluSW5kZW50KClcbiAgICAgICAgXG4gICAgICAgIEBzdXJyb3VuZFN0YWNrID0gW11cbiAgICAgICAgQGRlbGV0ZVNlbGVjdGlvbigpXG4gICAgICAgIEBkby5zdGFydCgpXG4gICAgICAgIFxuICAgICAgICBpZiBAc2FsdGVyTW9kZVxuICAgICAgICAgICAgbmV3Q3Vyc29ycyA9IFtyYW5nZUVuZFBvcyBAcmFuZ2VGb3JMaW5lQXRJbmRleCBAbWFpbkN1cnNvcigpWzFdXVxuICAgICAgICAgICAgQHNldFNhbHRlck1vZGUgZmFsc2VcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgbmV3Q3Vyc29ycyA9IEBkby5jdXJzb3JzKClcbiAgICAgICAgXG4gICAgICAgIGZvciBjIGluIEBkby5jdXJzb3JzKCkucmV2ZXJzZSgpXG4gICAgICAgIFxuICAgICAgICAgICAgW2JlZm9yZSwgYWZ0ZXJdID0gQHNwbGl0U3RhdGVMaW5lQXRQb3MgQGRvLCBjXG4gICAgICAgICAgICBhZnRlciA9IGFmdGVyLnRyaW1MZWZ0KCkgaWYgZG9JbmRlbnRcbiAgICAgICAgXG4gICAgICAgICAgICBpZiBkb0luZGVudFxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGluZGVudCA9IEBpbmRlbnRTdHJpbmdGb3JMaW5lQXRJbmRleCBjWzFdIFxuICAgICAgICAgICAgICAgIGlmIEBmaWxlVHlwZSBpbiBbJ2NvZmZlZScsICdrb2ZmZWUnXVxuICAgICAgICAgICAgICAgICAgICBpZiAvKHdoZW58aWYpLy50ZXN0IGJlZm9yZSBcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGFmdGVyLnN0YXJ0c1dpdGggJ3RoZW4gJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyID0gYWZ0ZXIuc2xpY2UoNCkudHJpbUxlZnQoKSAjIHJlbW92ZSB0aGVuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZW50ICs9IEBpbmRlbnRTdHJpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgYmVmb3JlLnRyaW0oKS5lbmRzV2l0aCAndGhlbidcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmUgPSBiZWZvcmUudHJpbVJpZ2h0KClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmUgPSBiZWZvcmUuc2xpY2UgMCwgYmVmb3JlLmxlbmd0aC00ICMgcmVtb3ZlIHRoZW4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZW50ICs9IEBpbmRlbnRTdHJpbmdcbiAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgaWYgY1swXSA8PSBpbmRlbnRhdGlvbkluTGluZSBAZG8ubGluZSBjWzFdXG4gICAgICAgICAgICAgICAgICAgIGluZGVudCA9IEBkby5saW5lKGNbMV0pLnNsaWNlIDAsY1swXVxuICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgaW5kZW50ID0gJydcblxuICAgICAgICAgICAgYmwgPSBjWzBdXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIGNbMF0gPj0gQGRvLmxpbmUoY1sxXSkubGVuZ3RoICMgY3Vyc29yIGF0IGVuZCBvZiBsaW5lXG4gICAgICAgICAgICAgICAgQGRvLmluc2VydCBjWzFdKzEsIGluZGVudFxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIEBkby5pbnNlcnQgY1sxXSsxLCBpbmRlbnQgKyBhZnRlclxuICAgICAgICAgICAgICAgIGlmIEBpbnNlcnRJbmRlbnRlZEVtcHR5TGluZUJldHdlZW4/IGFuZFxuICAgICAgICAgICAgICAgICAgICBiZWZvcmUudHJpbVJpZ2h0KCkuZW5kc1dpdGggQGluc2VydEluZGVudGVkRW1wdHlMaW5lQmV0d2VlblswXSBhbmRcbiAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyLnRyaW1MZWZ0KCkuc3RhcnRzV2l0aCBAaW5zZXJ0SW5kZW50ZWRFbXB0eUxpbmVCZXR3ZWVuWzFdXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZW50ICs9IEBpbmRlbnRTdHJpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBAZG8uaW5zZXJ0IGNbMV0rMSwgaW5kZW50XG4gICAgICAgICAgICAgICAgQGRvLmNoYW5nZSBjWzFdLCBiZWZvcmVcblxuICAgICAgICAgICAgIyBtb3ZlIGN1cnNvcnMgaW4gYW5kIGJlbG93IGluc2VydGVkIGxpbmUgZG93blxuICAgICAgICAgICAgZm9yIG5jIGluIHBvc2l0aW9uc0Zyb21Qb3NJblBvc2l0aW9ucyBjLCBuZXdDdXJzb3JzXG4gICAgICAgICAgICAgICAgY3Vyc29yRGVsdGEgbmMsIG5jWzFdID09IGNbMV0gYW5kIGluZGVudC5sZW5ndGggLSBibCBvciAwLCAxXG4gICAgICAgIFxuICAgICAgICBAZG8uc2V0Q3Vyc29ycyBuZXdDdXJzb3JzXG4gICAgICAgIEBkby5lbmQoKVxuIl19
//# sourceURL=../../../coffee/editor/actions/newline.coffee