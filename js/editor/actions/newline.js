// koffee 1.4.0

/*
000   000  00000000  000   000  000      000  000   000  00000000
0000  000  000       000 0 000  000      000  0000  000  000     
000 0 000  0000000   000000000  000      000  000 0 000  0000000 
000  0000  000       000   000  000      000  000  0000  000     
000   000  00000000  00     00  0000000  000  000   000  00000000
 */
var _;

_ = require('kxk')._;

module.exports = {
    actions: {
        menu: 'Line',
        newline: {
            name: 'Insert Newline',
            combos: ['enter']
        },
        newlineAtEnd: {
            name: 'Insert Newline at End',
            combo: 'alt+enter'
        }
    },
    newlineAtEnd: function() {
        this.moveCursorsToLineBoundary('right');
        return this.newline({
            indent: true
        });
    },
    newline: function(key, info) {
        var after, before, bl, c, doIndent, i, indent, j, len, len1, nc, newCursors, ref, ref1, ref2, ref3, ref4;
        if ((info == null) && _.isObject(key)) {
            info = key;
        }
        if (this.salterMode) {
            this.endSalter();
            this.singleCursorAtPos(_.last(this.cursors()));
            this.newlineAtEnd();
            return;
        }
        doIndent = (ref = info != null ? info.indent : void 0) != null ? ref : !this.isCursorInIndent();
        this.surroundStack = [];
        this.deleteSelection();
        this["do"].start();
        if (this.salterMode) {
            newCursors = [rangeEndPos(this.rangeForLineAtIndex(this.mainCursor()[1]))];
            this.setSalterMode(false);
        } else {
            newCursors = this["do"].cursors();
        }
        ref1 = this["do"].cursors().reverse();
        for (i = 0, len = ref1.length; i < len; i++) {
            c = ref1[i];
            ref2 = this.splitStateLineAtPos(this["do"], c), before = ref2[0], after = ref2[1];
            if (doIndent) {
                after = after.trimLeft();
            }
            if (doIndent) {
                indent = this.indentStringForLineAtIndex(c[1]);
                if ((ref3 = this.fileType) === 'coffee' || ref3 === 'koffee') {
                    if (/(when|if)/.test(before)) {
                        if (after.startsWith('then ')) {
                            after = after.slice(4).trimLeft();
                            indent += this.indentString;
                        } else if (before.trim().endsWith('then')) {
                            before = before.trimRight();
                            before = before.slice(0, before.length - 4);
                            indent += this.indentString;
                        }
                    }
                }
            } else {
                if (c[0] <= indentationInLine(this["do"].line(c[1]))) {
                    indent = this["do"].line(c[1]).slice(0, c[0]);
                } else {
                    indent = '';
                }
            }
            bl = c[0];
            if (c[0] >= this["do"].line(c[1]).length) {
                this["do"].insert(c[1] + 1, indent);
            } else {
                this["do"].insert(c[1] + 1, indent + after);
                if ((this.insertIndentedEmptyLineBetween != null) && before.trimRight().endsWith(this.insertIndentedEmptyLineBetween[0] && after.trimLeft().startsWith(this.insertIndentedEmptyLineBetween[1]))) {
                    indent += this.indentString;
                    this["do"].insert(c[1] + 1, indent);
                }
                this["do"].change(c[1], before);
            }
            ref4 = positionsFromPosInPositions(c, newCursors);
            for (j = 0, len1 = ref4.length; j < len1; j++) {
                nc = ref4[j];
                cursorDelta(nc, nc[1] === c[1] && indent.length - bl || 0, 1);
            }
        }
        this["do"].setCursors(newCursors);
        return this["do"].end();
    }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmV3bGluZS5qcyIsInNvdXJjZVJvb3QiOiIuIiwic291cmNlcyI6WyIiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7OztBQUFBLElBQUE7O0FBUUUsSUFBTSxPQUFBLENBQVEsS0FBUjs7QUFFUixNQUFNLENBQUMsT0FBUCxHQUVJO0lBQUEsT0FBQSxFQUNJO1FBQUEsSUFBQSxFQUFNLE1BQU47UUFFQSxPQUFBLEVBQ0k7WUFBQSxJQUFBLEVBQU0sZ0JBQU47WUFDQSxNQUFBLEVBQVEsQ0FBQyxPQUFELENBRFI7U0FISjtRQU1BLFlBQUEsRUFDSTtZQUFBLElBQUEsRUFBTyx1QkFBUDtZQUNBLEtBQUEsRUFBTyxXQURQO1NBUEo7S0FESjtJQVdBLFlBQUEsRUFBYyxTQUFBO1FBRVYsSUFBQyxDQUFBLHlCQUFELENBQTJCLE9BQTNCO2VBQ0EsSUFBQyxDQUFBLE9BQUQsQ0FBUztZQUFBLE1BQUEsRUFBUSxJQUFSO1NBQVQ7SUFIVSxDQVhkO0lBZ0JBLE9BQUEsRUFBUyxTQUFDLEdBQUQsRUFBTSxJQUFOO0FBRUwsWUFBQTtRQUFBLElBQU8sY0FBSixJQUFjLENBQUMsQ0FBQyxRQUFGLENBQVcsR0FBWCxDQUFqQjtZQUNJLElBQUEsR0FBTyxJQURYOztRQUdBLElBQUcsSUFBQyxDQUFBLFVBQUo7WUFDSSxJQUFDLENBQUEsU0FBRCxDQUFBO1lBQ0EsSUFBQyxDQUFBLGlCQUFELENBQW1CLENBQUMsQ0FBQyxJQUFGLENBQU8sSUFBQyxDQUFBLE9BQUQsQ0FBQSxDQUFQLENBQW5CO1lBQ0EsSUFBQyxDQUFBLFlBQUQsQ0FBQTtBQUNBLG1CQUpKOztRQU1BLFFBQUEsK0RBQTBCLENBQUksSUFBQyxDQUFBLGdCQUFELENBQUE7UUFFOUIsSUFBQyxDQUFBLGFBQUQsR0FBaUI7UUFDakIsSUFBQyxDQUFBLGVBQUQsQ0FBQTtRQUNBLElBQUMsRUFBQSxFQUFBLEVBQUUsQ0FBQyxLQUFKLENBQUE7UUFFQSxJQUFHLElBQUMsQ0FBQSxVQUFKO1lBQ0ksVUFB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RixHQUFLLENBQWhCLEVBQW1CLE1BQW5CLEVBSlo7O2dCQUtBLElBQUMsRUFBQSxFQUFBLEVBQUUsQ0FBQyxNQUFKLENBQVcsQ0FBRSxDQUFBLENBQUEsQ0FBYixFQUFpQixNQUFqQixFQVRKOztBQVlBO0FBQUEsaUJBQUEsd0NBQUE7O2dCQUNJLFdBQUEsQ0FBWSxFQUFaLEVBQWdCLEVBQUcsQ0FBQSxDQUFBLENBQUgsS0FBUyxDQUFFLENBQUEsQ0FBQSxDQUFYLElBQWtCLE1BQU0sQ0FBQyxNQUFQLEdBQWdCLEVBQWxDLElBQXdDLENBQXhELEVBQTJELENBQTNEO0FBREo7QUF0Q0o7UUF5Q0EsSUFBQyxFQUFBLEVBQUEsRUFBRSxDQUFDLFVBQUosQ0FBZSxVQUFmO2VBQ0EsSUFBQyxFQUFBLEVBQUEsRUFBRSxDQUFDLEdBQUosQ0FBQTtJQWpFSyxDQWhCVCIsInNvdXJjZXNDb250ZW50IjpbIiMjI1xuMDAwICAgMDAwICAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDBcbjAwMDAgIDAwMCAgMDAwICAgICAgIDAwMCAwIDAwMCAgMDAwICAgICAgMDAwICAwMDAwICAwMDAgIDAwMCAgICAgXG4wMDAgMCAwMDAgIDAwMDAwMDAgICAwMDAwMDAwMDAgIDAwMCAgICAgIDAwMCAgMDAwIDAgMDAwICAwMDAwMDAwIFxuMDAwICAwMDAwICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgIDAwMCAgMDAwMCAgMDAwICAgICBcbjAwMCAgIDAwMCAgMDAwMDAwMDAgIDAwICAgICAwMCAgMDAwMDAwMCAgMDAwICAwMDAgICAwMDAgIDAwMDAwMDAwXG4jIyNcblxueyBfIH0gPSByZXF1aXJlICdreGsnXG5cbm1vZHVsZS5leHBvcnRzID0gXG4gICAgXG4gICAgYWN0aW9uczpcbiAgICAgICAgbWVudTogJ0xpbmUnXG4gICAgICAgIFxuICAgICAgICBuZXdsaW5lOlxuICAgICAgICAgICAgbmFtZTogJ0luc2VydCBOZXdsaW5lJ1xuICAgICAgICAgICAgY29tYm9zOiBbJ2VudGVyJ11cbiAgICAgICAgICAgIFxuICAgICAgICBuZXdsaW5lQXRFbmQ6XG4gICAgICAgICAgICBuYW1lOiAgJ0luc2VydCBOZXdsaW5lIGF0IEVuZCdcbiAgICAgICAgICAgIGNvbWJvOiAnYWx0K2VudGVyJ1xuXG4gICAgbmV3bGluZUF0RW5kOiAoKSAtPlxuICAgICAgICBcbiAgICAgICAgQG1vdmVDdXJzb3JzVG9MaW5lQm91bmRhcnkgJ3JpZ2h0JyAgXG4gICAgICAgIEBuZXdsaW5lIGluZGVudDogdHJ1ZVxuXG4gICAgbmV3bGluZTogKGtleSwgaW5mbykgLT5cbiAgICAgICAgXG4gICAgICAgIGlmIG5vdCBpbmZvPyBhbmQgXy5pc09iamVjdCBrZXlcbiAgICAgICAgICAgIGluZm8gPSBrZXlcblxuICAgICAgICBpZiBAc2FsdGVyTW9kZSBcbiAgICAgICAgICAgIEBlbmRTYWx0ZXIoKVxuICAgICAgICAgICAgQHNpbmdsZUN1cnNvckF0UG9zIF8ubGFzdCBAY3Vyc29ycygpXG4gICAgICAgICAgICBAbmV3bGluZUF0RW5kKClcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICBcbiAgICAgICAgZG9JbmRlbnQgPSBpbmZvPy5pbmRlbnQgPyBub3QgQGlzQ3Vyc29ySW5JbmRlbnQoKVxuICAgICAgICBcbiAgICAgICAgQHN1cnJvdW5kU3RhY2sgPSBbXVxuICAgICAgICBAZGVsZXRlU2VsZWN0aW9uKClcbiAgICAgICAgQGRvLnN0YXJ0KClcbiAgICAgICAgXG4gICAgICAgIGlmIEBzYWx0ZXJNb2RlXG4gICAgICAgICAgICBuZXdDdXJzb3JzID0gW3JhbmdlRW5kUG9zIEByYW5nZUZvckxpbmVBdEluZGV4IEBtYWluQ3Vyc29yKClbMV1dXG4gICAgICAgICAgICBAc2V0U2FsdGVyTW9kZSBmYWxzZVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICBuZXdDdXJzb3JzID0gQGRvLmN1cnNvcnMoKVxuICAgICAgICBcbiAgICAgICAgZm9yIGMgaW4gQGRvLmN1cnNvcnMoKS5yZXZlcnNlKClcbiAgICAgICAgXG4gICAgICAgICAgICBbYmVmb3JlLCBhZnRlcl0gPSBAc3BsaXRTdGF0ZUxpbmVBdFBvcyBAZG8sIGNcbiAgICAgICAgICAgIGFmdGVyID0gYWZ0ZXIudHJpbUxlZnQoKSBpZiBkb0luZGVudFxuICAgICAgICBcbiAgICAgICAgICAgIGlmIGRvSW5kZW50XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaW5kZW50ID0gQGluZGVudFN0cmluZ0ZvckxpbmVBdEluZGV4IGNbMV0gXG4gICAgICAgICAgICAgICAgaWYgQGZpbGVUeXBlIGluIFsnY29mZmVlJywgJ2tvZmZlZSddXG4gICAgICAgICAgICAgICAgICAgIGlmIC8od2hlbnxpZikvLnRlc3QgYmVmb3JlIFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgYWZ0ZXIuc3RhcnRzV2l0aCAndGhlbiAnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXIgPSBhZnRlci5zbGljZSg0KS50cmltTGVmdCgpICMgcmVtb3ZlIHRoZW5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRlbnQgKz0gQGluZGVudFN0cmluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiBiZWZvcmUudHJpbSgpLmVuZHNXaXRoICd0aGVuJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZSA9IGJlZm9yZS50cmltUmlnaHQoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZSA9IGJlZm9yZS5zbGljZSAwLCBiZWZvcmUubGVuZ3RoLTQgIyByZW1vdmUgdGhlbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRlbnQgKz0gQGluZGVudFN0cmluZ1xuICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBpZiBjWzBdIDw9IGluZGVudGF0aW9uSW5MaW5lIEBkby5saW5lIGNbMV1cbiAgICAgICAgICAgICAgICAgICAgaW5kZW50ID0gQGRvLmxpbmUoY1sxXSkuc2xpY2UgMCxjWzBdXG4gICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICBpbmRlbnQgPSAnJ1xuXG4gICAgICAgICAgICBibCA9IGNbMF1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgY1swXSA+PSBAZG8ubGluZShjWzFdKS5sZW5ndGggIyBjdXJzb3IgYXQgZW5kIG9mIGxpbmVcbiAgICAgICAgICAgICAgICBAZG8uaW5zZXJ0IGNbMV0rMSwgaW5kZW50XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgQGRvLmluc2VydCBjWzFdKzEsIGluZGVudCArIGFmdGVyXG4gICAgICAgICAgICAgICAgaWYgQGluc2VydEluZGVudGVkRW1wdHlMaW5lQmV0d2Vlbj8gYW5kXG4gICAgICAgICAgICAgICAgICAgIGJlZm9yZS50cmltUmlnaHQoKS5lbmRzV2l0aCBAaW5zZXJ0SW5kZW50ZWRFbXB0eUxpbmVCZXR3ZWVuWzBdIGFuZFxuICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXIudHJpbUxlZnQoKS5zdGFydHNXaXRoIEBpbnNlcnRJbmRlbnRlZEVtcHR5TGluZUJldHdlZW5bMV1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRlbnQgKz0gQGluZGVudFN0cmluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIEBkby5pbnNlcnQgY1sxXSsxLCBpbmRlbnRcbiAgICAgICAgICAgICAgICBAZG8uY2hhbmdlIGNbMV0sIGJlZm9yZVxuXG4gICAgICAgICAgICAjIG1vdmUgY3Vyc29ycyBpbiBhbmQgYmVsb3cgaW5zZXJ0ZWQgbGluZSBkb3duXG4gICAgICAgICAgICBmb3IgbmMgaW4gcG9zaXRpb25zRnJvbVBvc0luUG9zaXRpb25zIGMsIG5ld0N1cnNvcnNcbiAgICAgICAgICAgICAgICBjdXJzb3JEZWx0YSBuYywgbmNbMV0gPT0gY1sxXSBhbmQgaW5kZW50Lmxlbmd0aCAtIGJsIG9yIDAsIDFcbiAgICAgICAgXG4gICAgICAgIEBkby5zZXRDdXJzb3JzIG5ld0N1cnNvcnNcbiAgICAgICAgQGRvLmVuZCgpXG4iXX0=
//# sourceURL=../../../coffee/editor/actions/newline.coffee