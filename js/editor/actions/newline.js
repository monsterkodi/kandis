// koffee 1.11.0

/*
000   000  00000000  000   000  000      000  000   000  00000000
0000  000  000       000 0 000  000      000  0000  000  000     
000 0 000  0000000   000000000  000      000  000 0 000  0000000 
000  0000  000       000   000  000      000  000  0000  000     
000   000  00000000  00     00  0000000  000  000   000  00000000
 */
var _, klog, last, ref;

ref = require('kxk'), _ = ref._, klog = ref.klog, last = ref.last;

module.exports = {
    actions: {
        menu: 'Line',
        newline: {
            name: 'Insert Newline',
            combos: ['enter']
        },
        newlineAtEnd: {
            name: 'Insert Newline at End',
            combo: 'alt+enter'
        }
    },
    newlineAtEnd: function() {
        this.moveCursorsToLineBoundary('right');
        return this.newline({
            indent: true
        });
    },
    newline: function(key, info) {
        var after, before, bl, c, doIndent, i, indent, j, len, len1, nc, newCursors, ref1, ref2, ref3, ref4, ref5;
        if ((info == null) && _.isObject(key)) {
            info = key;
        }
        if (this.salterMode) {
            klog('newline endSalter');
            this.endSalter();
            this.singleCursorAtPos(last(this.cursors()));
            klog('newline cursors', this.cursors());
            this.newlineAtEnd();
            return;
        }
        doIndent = (ref1 = info != null ? info.indent : void 0) != null ? ref1 : !this.isCursorInIndent();
        this.surroundStack = [];
        this.deleteSelection();
        this["do"].start();
        if (this.salterMode) {
            newCursors = [rangeEndPos(this.rangeForLineAtIndex(this.mainCursor()[1]))];
            this.setSalterMode(false);
        } else {
            newCursors = this["do"].cursors();
        }
        ref2 = this["do"].cursors().reverse();
        for (i = 0, len = ref2.length; i < len; i++) {
            c = ref2[i];
            ref3 = this.splitStateLineAtPos(this["do"], c), before = ref3[0], after = ref3[1];
            if (doIndent) {
                after = after.trimLeft();
            }
            if (doIndent) {
                indent = this.indentStringForLineAtIndex(c[1]);
                if ((ref4 = this.fileType) === 'coffee' || ref4 === 'koffee') {
                    if (/(when|if)/.test(before)) {
                        if (after.startsWith('then ')) {
                            after = after.slice(4).trimLeft();
                            indent += this.indentString;
                        } else if (before.trim().endsWith('then')) {
                            before = before.trimRight();
                            before = before.slice(0, before.length - 4);
                            indent += this.indentString;
                        }
                    }
                }
            } else {
                if (c[0] <= indentationInLine(this["do"].line(c[1]))) {
                    indent = this["do"].line(c[1]).slice(0, c[0]);
                } else {
                    indent = '';
                }
            }
            bl = c[0];
            if (c[0] >= this["do"].line(c[1]).length) {
                this["do"].insert(c[1] + 1, indent);
            } else {
                this["do"].insert(c[1] + 1, indent + after);
                if ((this.insertIndentedEmptyLineBetween != null) && before.trimRight().endsWith(this.insertIndentedEmptyLineBetween[0] && after.trimLeft().startsWith(this.insertIndentedEmptyLineBetween[1]))) {
                    indent += this.indentString;
                    this["do"].insert(c[1] + 1, indent);
                }
                this["do"].change(c[1], before);
            }
            ref5 = positionsFromPosInPositions(c, newCursors);
            for (j = 0, len1 = ref5.length; j < len1; j++) {
                nc = ref5[j];
                cursorDelta(nc, nc[1] === c[1] && indent.length - bl || 0, 1);
            }
        }
        this["do"].setCursors(newCursors);
        return this["do"].end();
    }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmV3bGluZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi9jb2ZmZWUvZWRpdG9yL2FjdGlvbnMiLCJzb3VyY2VzIjpbIm5ld2xpbmUuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7QUFBQSxJQUFBOztBQVFBLE1BQW9CLE9BQUEsQ0FBUSxLQUFSLENBQXBCLEVBQUUsU0FBRixFQUFLLGVBQUwsRUFBVzs7QUFFWCxNQUFNLENBQUMsT0FBUCxHQUVJO0lBQUEsT0FBQSxFQUNJO1FBQUEsSUFBQSxFQUFNLE1BQU47UUFFQSxPQUFBLEVBQ0k7WUFBQSxJQUFBLEVBQU0sZ0JBQU47WUFDQSxNQUFBLEVBQVEsQ0FBQyxPQUFELENBRFI7U0FISjtRQU1BLFlBQUEsRUFDSTtZQUFBLElBQUEsRUFBTyx1QkFBUDtZQUNBLEtBQUEsRUFBTyxXQURQO1NBUEo7S0FESjtJQVdBLFlBQUEsRUFBYyxTQUFBO1FBRVYsSUFBQyxDQUFBLHlCQUFELENBQTJCLE9BQTNCO2VBQ0EsSUFBQyxDQUFBLE9BQUQsQ0FBUztZQUFBLE1BQUEsRUFBUSxJQUFSO1NBQVQ7SUFIVSxDQVhkO0lBZ0JBLE9BQUEsRUFBUyxTQUFDLEdBQUQsRUFBTSxJQUFOO0FBRUwsWUFBQTtRQUFBLElBQU8sY0FBSixJQUFjLENBQUMsQ0FBQyxRQUFGLENBQVcsR0FBWCxDQUFqQjtZQUNJLElBQUEsR0FBTyxJQURYOztRQUdBLElBQUcsSUFBQyxDQUFBLFVBQUo7WUFDSSxJQUFBLENBQUssbUJBQUw7WUFDQSxJQUFDLENBQUEsU0FBRCxDQUFBO1lBQ0EsSUFBQyxDQUFBLGlCQUFELENBQW1CLElBQUEsQ0FBSyxJQUFDLENBQUEsT0FBRCxDQUFBLENBQUwsQ0FBbkI7WUFDQSxJQUFBLENBQUssaUJBQUwsRUFBdUIsSUFBQyxDQUFBLE9BQUQsQ0FBQSxDQUF2QjtZQUNBLElBQUMsQ0FBQSxZQUFELENBQUE7QUFDQSxtQkFOSjs7UUFRQSxRQUFBLGlFQUEwQixDQUFJLElBQUMsQ0FB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QUFqQixDQUE0QixJQUFDLENBQUEsOEJBQStCLENBQUEsQ0FBQSxDQUE1RCxDQURKLENBREo7b0JBR1ksTUFBQSxJQUFVLElBQUMsQ0FBQTtvQkFDWCxJQUFDLEVBQUEsRUFBQSxFQUFFLENBQUMsTUFBSixDQUFXLENBQUUsQ0FBQSxDQUFBLENBQUYsR0FBSyxDQUFoQixFQUFtQixNQUFuQixFQUpaOztnQkFLQSxJQUFDLEVBQUEsRUFBQSxFQUFFLENBQUMsTUFBSixDQUFXLENBQUUsQ0FBQSxDQUFBLENBQWIsRUFBaUIsTUFBakIsRUFUSjs7QUFZQTtBQUFBLGlCQUFBLHdDQUFBOztnQkFDSSxXQUFBLENBQVksRUFBWixFQUFnQixFQUFHLENBQUEsQ0FBQSxDQUFILEtBQVMsQ0FBRSxDQUFBLENBQUEsQ0FBWCxJQUFrQixNQUFNLENBQUMsTUFBUCxHQUFnQixFQUFsQyxJQUF3QyxDQUF4RCxFQUEyRCxDQUEzRDtBQURKO0FBdENKO1FBeUNBLElBQUMsRUFBQSxFQUFBLEVBQUUsQ0FBQyxVQUFKLENBQWUsVUFBZjtlQUNBLElBQUMsRUFBQSxFQUFBLEVBQUUsQ0FBQyxHQUFKLENBQUE7SUFuRUssQ0FoQlQiLCJzb3VyY2VzQ29udGVudCI6WyIjIyNcbjAwMCAgIDAwMCAgMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgMDAwICAwMDAgICAwMDAgIDAwMDAwMDAwXG4wMDAwICAwMDAgIDAwMCAgICAgICAwMDAgMCAwMDAgIDAwMCAgICAgIDAwMCAgMDAwMCAgMDAwICAwMDAgICAgIFxuMDAwIDAgMDAwICAwMDAwMDAwICAgMDAwMDAwMDAwICAwMDAgICAgICAwMDAgIDAwMCAwIDAwMCAgMDAwMDAwMCBcbjAwMCAgMDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgICAgMDAwICAwMDAgIDAwMDAgIDAwMCAgICAgXG4wMDAgICAwMDAgIDAwMDAwMDAwICAwMCAgICAgMDAgIDAwMDAwMDAgIDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMFxuIyMjXG5cbnsgXywga2xvZywgbGFzdCB9ID0gcmVxdWlyZSAna3hrJ1xuXG5tb2R1bGUuZXhwb3J0cyA9IFxuICAgIFxuICAgIGFjdGlvbnM6XG4gICAgICAgIG1lbnU6ICdMaW5lJ1xuICAgICAgICBcbiAgICAgICAgbmV3bGluZTpcbiAgICAgICAgICAgIG5hbWU6ICdJbnNlcnQgTmV3bGluZSdcbiAgICAgICAgICAgIGNvbWJvczogWydlbnRlciddXG4gICAgICAgICAgICBcbiAgICAgICAgbmV3bGluZUF0RW5kOlxuICAgICAgICAgICAgbmFtZTogICdJbnNlcnQgTmV3bGluZSBhdCBFbmQnXG4gICAgICAgICAgICBjb21ibzogJ2FsdCtlbnRlcidcblxuICAgIG5ld2xpbmVBdEVuZDogKCkgLT5cbiAgICAgICAgXG4gICAgICAgIEBtb3ZlQ3Vyc29yc1RvTGluZUJvdW5kYXJ5ICdyaWdodCcgIFxuICAgICAgICBAbmV3bGluZSBpbmRlbnQ6IHRydWVcblxuICAgIG5ld2xpbmU6IChrZXksIGluZm8pIC0+XG4gICAgICAgIFxuICAgICAgICBpZiBub3QgaW5mbz8gYW5kIF8uaXNPYmplY3Qga2V5XG4gICAgICAgICAgICBpbmZvID0ga2V5XG5cbiAgICAgICAgaWYgQHNhbHRlck1vZGVcbiAgICAgICAgICAgIGtsb2cgJ25ld2xpbmUgZW5kU2FsdGVyJ1xuICAgICAgICAgICAgQGVuZFNhbHRlcigpXG4gICAgICAgICAgICBAc2luZ2xlQ3Vyc29yQXRQb3MgbGFzdCBAY3Vyc29ycygpXG4gICAgICAgICAgICBrbG9nICduZXdsaW5lIGN1cnNvcnMnIEBjdXJzb3JzKClcbiAgICAgICAgICAgIEBuZXdsaW5lQXRFbmQoKVxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIFxuICAgICAgICBkb0luZGVudCA9IGluZm8/LmluZGVudCA/IG5vdCBAaXNDdXJzb3JJbkluZGVudCgpXG4gICAgICAgIFxuICAgICAgICBAc3Vycm91bmRTdGFjayA9IFtdXG4gICAgICAgIEBkZWxldGVTZWxlY3Rpb24oKVxuICAgICAgICBAZG8uc3RhcnQoKVxuICAgICAgICBcbiAgICAgICAgaWYgQHNhbHRlck1vZGVcbiAgICAgICAgICAgIG5ld0N1cnNvcnMgPSBbcmFuZ2VFbmRQb3MgQHJhbmdlRm9yTGluZUF0SW5kZXggQG1haW5DdXJzb3IoKVsxXV1cbiAgICAgICAgICAgIEBzZXRTYWx0ZXJNb2RlIGZhbHNlXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIG5ld0N1cnNvcnMgPSBAZG8uY3Vyc29ycygpXG4gICAgICAgIFxuICAgICAgICBmb3IgYyBpbiBAZG8uY3Vyc29ycygpLnJldmVyc2UoKVxuICAgICAgICBcbiAgICAgICAgICAgIFtiZWZvcmUsIGFmdGVyXSA9IEBzcGxpdFN0YXRlTGluZUF0UG9zIEBkbywgY1xuICAgICAgICAgICAgYWZ0ZXIgPSBhZnRlci50cmltTGVmdCgpIGlmIGRvSW5kZW50XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgZG9JbmRlbnRcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpbmRlbnQgPSBAaW5kZW50U3RyaW5nRm9yTGluZUF0SW5kZXggY1sxXSBcbiAgICAgICAgICAgICAgICBpZiBAZmlsZVR5cGUgaW4gWydjb2ZmZWUnLCAna29mZmVlJ11cbiAgICAgICAgICAgICAgICAgICAgaWYgLyh3aGVufGlmKS8udGVzdCBiZWZvcmUgXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiBhZnRlci5zdGFydHNXaXRoICd0aGVuICdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlciA9IGFmdGVyLnNsaWNlKDQpLnRyaW1MZWZ0KCkgIyByZW1vdmUgdGhlblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGVudCArPSBAaW5kZW50U3RyaW5nXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIGJlZm9yZS50cmltKCkuZW5kc1dpdGggJ3RoZW4nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlID0gYmVmb3JlLnRyaW1SaWdodCgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlID0gYmVmb3JlLnNsaWNlIDAsIGJlZm9yZS5sZW5ndGgtNCAjIHJlbW92ZSB0aGVuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGVudCArPSBAaW5kZW50U3RyaW5nXG4gICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIGlmIGNbMF0gPD0gaW5kZW50YXRpb25JbkxpbmUgQGRvLmxpbmUgY1sxXVxuICAgICAgICAgICAgICAgICAgICBpbmRlbnQgPSBAZG8ubGluZShjWzFdKS5zbGljZSAwLGNbMF1cbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIGluZGVudCA9ICcnXG5cbiAgICAgICAgICAgIGJsID0gY1swXVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiBjWzBdID49IEBkby5saW5lKGNbMV0pLmxlbmd0aCAjIGN1cnNvciBhdCBlbmQgb2YgbGluZVxuICAgICAgICAgICAgICAgIEBkby5pbnNlcnQgY1sxXSsxLCBpbmRlbnRcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBAZG8uaW5zZXJ0IGNbMV0rMSwgaW5kZW50ICsgYWZ0ZXJcbiAgICAgICAgICAgICAgICBpZiBAaW5zZXJ0SW5kZW50ZWRFbXB0eUxpbmVCZXR3ZWVuPyBhbmRcbiAgICAgICAgICAgICAgICAgICAgYmVmb3JlLnRyaW1SaWdodCgpLmVuZHNXaXRoIEBpbnNlcnRJbmRlbnRlZEVtcHR5TGluZUJldHdlZW5bMF0gYW5kXG4gICAgICAgICAgICAgICAgICAgICAgICBhZnRlci50cmltTGVmdCgpLnN0YXJ0c1dpdGggQGluc2VydEluZGVudGVkRW1wdHlMaW5lQmV0d2VlblsxXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGVudCArPSBAaW5kZW50U3RyaW5nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgQGRvLmluc2VydCBjWzFdKzEsIGluZGVudFxuICAgICAgICAgICAgICAgIEBkby5jaGFuZ2UgY1sxXSwgYmVmb3JlXG5cbiAgICAgICAgICAgICMgbW92ZSBjdXJzb3JzIGluIGFuZCBiZWxvdyBpbnNlcnRlZCBsaW5lIGRvd25cbiAgICAgICAgICAgIGZvciBuYyBpbiBwb3NpdGlvbnNGcm9tUG9zSW5Qb3NpdGlvbnMgYywgbmV3Q3Vyc29yc1xuICAgICAgICAgICAgICAgIGN1cnNvckRlbHRhIG5jLCBuY1sxXSA9PSBjWzFdIGFuZCBpbmRlbnQubGVuZ3RoIC0gYmwgb3IgMCwgMVxuICAgICAgICBcbiAgICAgICAgQGRvLnNldEN1cnNvcnMgbmV3Q3Vyc29yc1xuICAgICAgICBAZG8uZW5kKClcbiJdfQ==
//# sourceURL=../../../coffee/editor/actions/newline.coffee