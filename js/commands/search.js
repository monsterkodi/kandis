// koffee 1.4.0

/*
 0000000  00000000   0000000   00000000    0000000  000   000
000       000       000   000  000   000  000       000   000
0000000   0000000   000000000  0000000    000       000000000
     000  000       000   000  000   000  000       000   000
0000000   00000000  000   000  000   000   0000000  000   000
 */
var Command, FileSearcher, Search, Syntax, _, fs, kerror, matchr, post, ref, slash, stream, walker,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty,
    indexOf = [].indexOf;

ref = require('kxk'), post = ref.post, matchr = ref.matchr, slash = ref.slash, fs = ref.fs, kerror = ref.kerror, _ = ref._;

walker = require('../tools/walker');

Syntax = require('../editor/syntax');

Command = require('../commandline/command');

stream = require('stream');

Search = (function(superClass) {
    extend(Search, superClass);

    function Search(commandline) {
        this.onMetaClick = bind(this.onMetaClick, this);
        this.searchInFile = bind(this.searchInFile, this);
        Search.__super__.constructor.call(this, commandline);
        this.names = ["search", "Search", "/search/", "/Search/"];
    }

    Search.prototype.historyKey = function() {
        return this.name;
    };

    Search.prototype.execute = function(command) {
        var file, ref1, rngs;
        if (!command.length) {
            return;
        }
        switch (this.name) {
            case '/search/':
            case '/Search/':
                if (command === '^' || command === '$' || command === '.') {
                    return;
                }
                rngs = matchr.ranges(command, '  ');
                if (rngs.length === 2) {
                    return;
                }
        }
        command = Search.__super__.execute.call(this, command);
        file = (ref1 = window.editor.currentFile) != null ? ref1 : _.first(_.keys(post.get('indexer', 'files')));
        if (file == null) {
            return;
        }
        window.terminal.doAutoClear();
        this.startSearchInFiles({
            text: command,
            name: this.name,
            file: slash.path(file)
        });
        return {
            focus: 'terminal',
            show: 'terminal',
            text: command,
            select: true
        };
    };

    Search.prototype.startSearchInFiles = function(opt) {
        var dir, terminal;
        terminal = window.terminal;
        terminal.appendMeta({
            clss: 'searchHeader',
            diss: Syntax.dissForTextAndSyntax("▸ Search for '" + opt.text + "':", 'ko')
        });
        terminal.appendMeta({
            clss: 'spacer'
        });
        terminal.singleCursorAtPos([0, terminal.numLines() - 2]);
        dir = slash.pkg(slash.dir(opt.file));
        if (dir != null) {
            dir;
        } else {
            dir = slash.dir(opt.file);
        }
        this.walker = new walker({
            root: dir,
            maxDepth: 12,
            maxFiles: 5000,
            includeDirs: false,
            file: (function(_this) {
                return function(f, stat) {
                    return _this.searchInFile(opt, slash.path(f));
                };
            })(this)
        });
        this.walker.cfg.ignore.push('js');
        this.walker.cfg.ignore.push('lib');
        return this.walker.start();
    };

    Search.prototype.searchInFile = function(opt, file) {
        stream = fs.createReadStream(file, {
            encoding: 'utf8'
        });
        return stream.pipe(new FileSearcher(this, opt, file));
    };

    Search.prototype.onMetaClick = function(meta, event) {
        var command, file, href, split;
        href = meta[2].href;
        if (href.startsWith('>')) {
            split = href.split('>');
            if (window.commandline.commands[split[1]] != null) {
                command = window.commandline.commands[split[1]];
                window.commandline.startCommand(split[1]);
                window.commandline.setText(split[2]);
                command.execute(split[2]);
            }
        } else {
            file = href + ':' + window.terminal.posForEvent(event)[0];
            post.emit('openFiles', [file], {
                newTab: event.metaKey
            });
        }
        return 'unhandled';
    };

    return Search;

})(Command);

FileSearcher = (function(superClass) {
    extend(FileSearcher, superClass);

    function FileSearcher(command1, opt1, file1) {
        var extn;
        this.command = command1;
        this.opt = opt1;
        this.file = file1;
        this.end = bind(this.end, this);
        FileSearcher.__super__.constructor.call(this);
        this.line = 0;
        this.flags = '';
        this.patterns = (function() {
            switch (this.opt.name) {
                case 'search':
                    return [[new RegExp(_.escapeRegExp(this.opt.text), 'i'), 'found']];
                case 'Search':
                    return [[new RegExp(_.escapeRegExp(this.opt.text)), 'found']];
                case '/search/':
                    this.flags = 'i';
                    return this.opt.text;
                case '/Search/':
                    return this.opt.text;
                default:
                    kerror("commands/search FileSearcher -- unhandled '" + this.opt.name + "' command:", this.command.name, 'opt:', this.opt, 'file:', this.file);
                    return [[new RegExp(_.escapeRegExp(this.opt.text), 'i'), 'found']];
            }
        }).call(this);
        this.found = [];
        extn = slash.ext(this.file);
        if (indexOf.call(Syntax.syntaxNames, extn) >= 0) {
            this.syntaxName = extn;
        } else {
            this.syntaxName = null;
        }
    }

    FileSearcher.prototype.write = function(chunk, encoding, cb) {
        var j, l, len, lines, rngs;
        lines = chunk.split('\n');
        if (this.syntaxName == null) {
            this.syntaxName = Syntax.shebang(lines[0]);
        }
        for (j = 0, len = lines.length; j < len; j++) {
            l = lines[j];
            this.line += 1;
            rngs = matchr.ranges(this.patterns, l, this.flags);
            if (rngs.length) {
                this.found.push([this.line, l, rngs]);
            }
        }
        return true;
    };

    FileSearcher.prototype.end = function(chunk, encoding, cb) {
        var dss, f, fi, j, meta, ref1, sytx, terminal;
        if (this.found.length) {
            terminal = window.terminal;
            meta = {
                diss: Syntax.dissForTextAndSyntax("" + (slash.tilde(this.file)), 'ko'),
                href: this.file,
                clss: 'gitInfoFile',
                click: this.command.onMetaClick,
                line: '◼'
            };
            terminal.appendMeta(meta);
            terminal.appendMeta({
                clss: 'spacer'
            });
            for (fi = j = 0, ref1 = this.found.length; 0 <= ref1 ? j < ref1 : j > ref1; fi = 0 <= ref1 ? ++j : --j) {
                f = this.found[fi];
                sytx = new Syntax(this.syntaxName, function(i) {
                    return f[1];
                });
                sytx.setFileType(this.syntaxName);
                dss = sytx.balancer.dissForLineAndRanges(f[1], f[2]);
                meta = {
                    diss: dss,
                    href: this.file + ":" + f[0],
                    clss: 'searchResult',
                    click: this.command.onMetaClick
                };
                if (fi && this.found[fi - 1][0] !== f[0] - 1) {
                    terminal.appendMeta({
                        clss: 'spacer'
                    });
                }
                terminal.appendMeta(meta);
                post.emit('search-result', meta);
            }
            terminal.appendMeta({
                clss: 'spacer'
            });
            return terminal.scroll.cursorToTop();
        }
    };

    return FileSearcher;

})(stream.Writable);

module.exports = Search;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLmpzIiwic291cmNlUm9vdCI6Ii4iLCJzb3VyY2VzIjpbIiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7O0FBQUEsSUFBQSw4RkFBQTtJQUFBOzs7OztBQVFBLE1BQXlDLE9BQUEsQ0FBUSxLQUFSLENBQXpDLEVBQUUsZUFBRixFQUFRLG1CQUFSLEVBQWdCLGlCQUFoQixFQUF1QixXQUF2QixFQUEyQixtQkFBM0IsRUFBbUM7O0FBRW5DLE1BQUEsR0FBVSxPQUFBLENBQVEsaUJBQVI7O0FBQ1YsTUFBQSxHQUFVLE9BQUEsQ0FBUSxrQkFBUjs7QUFDVixPQUFBLEdBQVUsT0FBQSxDQUFRLHdCQUFSOztBQUNWLE1BQUEsR0FBVSxPQUFBLENBQVEsUUFBUjs7QUFFSjs7O0lBRUMsZ0JBQUMsV0FBRDs7O1FBRUMsd0NBQU0sV0FBTjtRQUVBLElBQUMsQ0FBQSxLQUFELEdBQVMsQ0FBQyxRQUFELEVBQVcsUUFBWCxFQUFxQixVQUFyQixFQUFpQyxVQUFqQztJQUpWOztxQkFNSCxVQUFBLEdBQVksU0FBQTtlQUFHLElBQUMsQ0FBQTtJQUFKOztxQkFRWixPQUFBLEdBQVMsU0FBQyxPQUFEO0FBRUwsWUFBQTtRQUFBLElBQVUsQ0FBSSxPQUFPLENBQUMsTUFBdEI7QUFBQSxtQkFBQTs7QUFFQSxnQkFBTyxJQUFDLENBQUEsSUFBUjtBQUFBLGlCQUNTLFVBRFQ7QUFBQSxpQkFDcUIsVUFEckI7Z0JBRVEsSUFBRyxPQUFBLEtBQVksR0FBWixJQUFBLE9BQUEsS0FBaUIsR0FBakIsSUFBQSxPQUFBLEtBQXNCLEdBQXpCO0FBQ0ksMkJBREo7O2dCQUVBLElBQUEsR0FBTyxNQUFNLENBQUMsTUFBUCxDQUFjLE9BQWQsRUFBdUIsSUFBdkI7Z0JBQ1AsSUFBRyxJQUFJLENBQUMsTUFBTCxLQUFlLENBQWxCO0FBQ0ksMkJBREo7O0FBTFI7UUFRQSxPQUFBLEdBQVUsb0NBQU0sT0FBTjtRQUNWLElBQUEsdURBQW1DLENBQUMsQ0FBQyxLQUFGLENBQVEs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QUEsQ0FEcEI7b0JBRUEsSUFBQSxFQUFNLGNBRk47b0JBR0EsS0FBQSxFQUFPLElBQUMsQ0FBQSxPQUFPLENBQUMsV0FIaEI7O2dCQUtKLElBQUcsRUFBQSxJQUFPLElBQUMsQ0FBQSxLQUFNLENBQUEsRUFBQSxHQUFHLENBQUgsQ0FBTSxDQUFBLENBQUEsQ0FBYixLQUFtQixDQUFFLENBQUEsQ0FBQSxDQUFGLEdBQUssQ0FBbEM7b0JBQ0ksUUFBUSxDQUFDLFVBQVQsQ0FBb0I7d0JBQUEsSUFBQSxFQUFNLFFBQU47cUJBQXBCLEVBREo7O2dCQUdBLFFBQVEsQ0FBQyxVQUFULENBQW9CLElBQXBCO2dCQUNBLElBQUksQ0FBQyxJQUFMLENBQVUsZUFBVixFQUEyQixJQUEzQjtBQWxCSjtZQW9CQSxRQUFRLENBQUMsVUFBVCxDQUFvQjtnQkFBQSxJQUFBLEVBQU0sUUFBTjthQUFwQjttQkFDQSxRQUFRLENBQUMsTUFBTSxDQUFDLFdBQWhCLENBQUEsRUFuQ0o7O0lBRkM7Ozs7R0FsQ2tCLE1BQU0sQ0FBQzs7QUF5RWxDLE1BQU0sQ0FBQyxPQUFQLEdBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiIyMjXG4gMDAwMDAwMCAgMDAwMDAwMDAgICAwMDAwMDAwICAgMDAwMDAwMDAgICAgMDAwMDAwMCAgMDAwICAgMDAwXG4wMDAgICAgICAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwXG4wMDAwMDAwICAgMDAwMDAwMCAgIDAwMDAwMDAwMCAgMDAwMDAwMCAgICAwMDAgICAgICAgMDAwMDAwMDAwXG4gICAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwXG4wMDAwMDAwICAgMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAgMDAwMDAwMCAgMDAwICAgMDAwXG4jIyNcblxueyBwb3N0LCBtYXRjaHIsIHNsYXNoLCBmcywga2Vycm9yLCBfIH0gPSByZXF1aXJlICdreGsnXG5cbndhbGtlciAgPSByZXF1aXJlICcuLi90b29scy93YWxrZXInXG5TeW50YXggID0gcmVxdWlyZSAnLi4vZWRpdG9yL3N5bnRheCdcbkNvbW1hbmQgPSByZXF1aXJlICcuLi9jb21tYW5kbGluZS9jb21tYW5kJ1xuc3RyZWFtICA9IHJlcXVpcmUgJ3N0cmVhbSdcblxuY2xhc3MgU2VhcmNoIGV4dGVuZHMgQ29tbWFuZFxuXG4gICAgQDogKGNvbW1hbmRsaW5lKSAtPlxuICAgICAgICBcbiAgICAgICAgc3VwZXIgY29tbWFuZGxpbmVcbiAgICAgICAgXG4gICAgICAgIEBuYW1lcyA9IFtcInNlYXJjaFwiLCBcIlNlYXJjaFwiLCBcIi9zZWFyY2gvXCIsIFwiL1NlYXJjaC9cIl1cbiAgICAgXG4gICAgaGlzdG9yeUtleTogLT4gQG5hbWVcbiAgICAgICAgICAgICAgICBcbiAgICAjIDAwMDAwMDAwICAwMDAgICAwMDAgIDAwMDAwMDAwICAgMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMDAgIDAwMDAwMDAwXG4gICAgIyAwMDAgICAgICAgIDAwMCAwMDAgICAwMDAgICAgICAgMDAwICAgICAgIDAwMCAgIDAwMCAgICAgMDAwICAgICAwMDAgICAgIFxuICAgICMgMDAwMDAwMCAgICAgMDAwMDAgICAgMDAwMDAwMCAgIDAwMCAgICAgICAwMDAgICAwMDAgICAgIDAwMCAgICAgMDAwMDAwMCBcbiAgICAjIDAwMCAgICAgICAgMDAwIDAwMCAgIDAwMCAgICAgICAwMDAgICAgICAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgICAgXG4gICAgIyAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMCAgIDAwMDAwMDAgICAwMDAwMDAwICAgICAgMDAwICAgICAwMDAwMDAwMFxuICAgIFxuICAgIGV4ZWN1dGU6IChjb21tYW5kKSAtPlxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGlmIG5vdCBjb21tYW5kLmxlbmd0aFxuICAgICAgICBcbiAgICAgICAgc3dpdGNoIEBuYW1lXG4gICAgICAgICAgICB3aGVuICcvc2VhcmNoLycsICcvU2VhcmNoLydcbiAgICAgICAgICAgICAgICBpZiBjb21tYW5kIGluIFsnXicsICckJywgJy4nXVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXG4gICAgICAgICAgICAgICAgcm5ncyA9IG1hdGNoci5yYW5nZXMgY29tbWFuZCwgJyAgJ1xuICAgICAgICAgICAgICAgIGlmIHJuZ3MubGVuZ3RoID09IDJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICAgICAgXG4gICAgICAgIGNvbW1hbmQgPSBzdXBlciBjb21tYW5kXG4gICAgICAgIGZpbGUgPSB3aW5kb3cuZWRpdG9yLmN1cnJlbnRGaWxlID8gXy5maXJzdCBfLmtleXMocG9zdC5nZXQoJ2luZGV4ZXInLCAnZmlsZXMnKSlcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBpZiBub3QgZmlsZT9cbiAgICAgICAgXG4gICAgICAgIHdpbmRvdy50ZXJtaW5hbC5kb0F1dG9DbGVhcigpXG4gICAgICAgIFxuICAgICAgICBAc3RhcnRTZWFyY2hJbkZpbGVzIFxuICAgICAgICAgICAgdGV4dDogY29tbWFuZFxuICAgICAgICAgICAgbmFtZTogQG5hbWVcbiAgICAgICAgICAgIGZpbGU6IHNsYXNoLnBhdGggZmlsZVxuICAgICAgICAgICAgXG4gICAgICAgIGZvY3VzOiAgJ3Rlcm1pbmFsJ1xuICAgICAgICBzaG93OiAgICd0ZXJtaW5hbCdcbiAgICAgICAgdGV4dDogICBjb21tYW5kXG4gICAgICAgIHNlbGVjdDogdHJ1ZVxuICAgICAgXG4gICAgIyAgMDAwMDAwMCAgMDAwMDAwMDAgICAwMDAwMDAwICAgMDAwMDAwMDAgICAgMDAwMDAwMCAgMDAwICAgMDAwXG4gICAgIyAwMDAgICAgICAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwXG4gICAgIyAwMDAwMDAwICAgMDAwMDAwMCAgIDAwMDAwMDAwMCAgMDAwMDAwMCAgICAwMDAgICAgICAgMDAwMDAwMDAwXG4gICAgIyAgICAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwXG4gICAgIyAwMDAwMDAwICAgMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAgMDAwMDAwMCAgMDAwICAgMDAwXG4gICAgXG4gICAgc3RhcnRTZWFyY2hJbkZpbGVzOiAob3B0KSAtPlxuICAgICAgICBcbiAgICAgICAgdGVybWluYWwgPSB3aW5kb3cudGVybWluYWxcbiAgICAgICAgIyB0ZXJtaW5hbC5hcHBlbmRNZXRhIGNsc3M6ICdzYWx0JywgdGV4dDogb3B0LnRleHQuc2xpY2UgMCwgMTRcbiAgICAgICAgdGVybWluYWwuYXBwZW5kTWV0YSBjbHNzOidzZWFyY2hIZWFkZXInLCBkaXNzOlN5bnRheC5kaXNzRm9yVGV4dEFuZFN5bnRheCBcIuKWuCBTZWFyY2ggZm9yICcje29wdC50ZXh0fSc6XCIsICdrbydcbiAgICAgICAgdGVybWluYWwuYXBwZW5kTWV0YSBjbHNzOidzcGFjZXInXG4gICAgICAgIHRlcm1pbmFsLnNpbmdsZUN1cnNvckF0UG9zIFswLCB0ZXJtaW5hbC5udW1MaW5lcygpLTJdXG4gICAgICAgIGRpciA9IHNsYXNoLnBrZyBzbGFzaC5kaXIgb3B0LmZpbGVcbiAgICAgICAgZGlyID89IHNsYXNoLmRpciBvcHQuZmlsZVxuICAgICAgICBAd2Fsa2VyID0gbmV3IHdhbGtlclxuICAgICAgICAgICAgcm9vdDogICAgICAgIGRpclxuICAgICAgICAgICAgbWF4RGVwdGg6ICAgIDEyXG4gICAgICAgICAgICBtYXhGaWxlczogICAgNTAwMFxuICAgICAgICAgICAgaW5jbHVkZURpcnM6IGZhbHNlXG4gICAgICAgICAgICBmaWxlOiAgICAgICAgKGYsc3RhdCkgPT4gQHNlYXJjaEluRmlsZSBvcHQsIHNsYXNoLnBhdGggZlxuICAgICAgICBAd2Fsa2VyLmNmZy5pZ25vcmUucHVzaCAnanMnICAjIHRoZXNlIGRpcmVjdG9yaWVzIGFyZSBub3QgaW5jbHVkZWQgaW4gc2VhcmNoIHJlc3VsdHNcbiAgICAgICAgQHdhbGtlci5jZmcuaWdub3JlLnB1c2ggJ2xpYicgIyB0aGV5IHNob3VsZCBiZSBjb25maWd1cmFibGUsIG1heWJlIGluIHBhY2thZ2Uubm9vbiBvciAua29ucmFkLm5vb24/XG4gICAgICAgIEB3YWxrZXIuc3RhcnQoKVxuICAgICAgICBcbiAgICBzZWFyY2hJbkZpbGU6IChvcHQsIGZpbGUpID0+XG5cbiAgICAgICAgc3RyZWFtID0gZnMuY3JlYXRlUmVhZFN0cmVhbSBmaWxlLCBlbmNvZGluZzogJ3V0ZjgnXG4gICAgICAgIHN0cmVhbS5waXBlIG5ldyBGaWxlU2VhcmNoZXIgQCwgb3B0LCBmaWxlXG5cbiAgICAjIDAwICAgICAwMCAgMDAwMDAwMDAgIDAwMDAwMDAwMCAgIDAwMDAwMDAgICAgMDAwMDAwMCAgMDAwICAgICAgMDAwICAgMDAwMDAwMCAgMDAwICAgMDAwICBcbiAgICAjIDAwMCAgIDAwMCAgMDAwICAgICAgICAgIDAwMCAgICAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgICAgMDAwICAwMDAgICAgICAgMDAwICAwMDAgICBcbiAgICAjIDAwMDAwMDAwMCAgMDAwMDAwMCAgICAgIDAwMCAgICAgMDAwMDAwMDAwICAwMDAgICAgICAgMDAwICAgICAgMDAwICAwMDAgICAgICAgMDAwMDAwMCAgICBcbiAgICAjIDAwMCAwIDAwMCAgMDAwICAgICAgICAgIDAwMCAgICAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgICAgMDAwICAwMDAgICAgICAgMDAwICAwMDAgICBcbiAgICAjIDAwMCAgIDAwMCAgMDAwMDAwMDAgICAgIDAwMCAgICAgMDAwICAgMDAwICAgMDAwMDAwMCAgMDAwMDAwMCAgMDAwICAgMDAwMDAwMCAgMDAwICAgMDAwICBcbiAgICBcbiAgICBvbk1ldGFDbGljazogKG1ldGEsIGV2ZW50KSA9PlxuXG4gICAgICAgIGhyZWYgPSBtZXRhWzJdLmhyZWYgICBcbiAgICAgICAgXG4gICAgICAgIGlmIGhyZWYuc3RhcnRzV2l0aCAnPidcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgc3BsaXQgPSBocmVmLnNwbGl0ICc+J1xuICAgICAgICAgICAgaWYgd2luZG93LmNvbW1hbmRsaW5lLmNvbW1hbmRzW3NwbGl0WzFdXT9cbiAgICAgICAgICAgICAgICBjb21tYW5kID0gd2luZG93LmNvbW1hbmRsaW5lLmNvbW1hbmRzW3NwbGl0WzFdXVxuICAgICAgICAgICAgICAgIHdpbmRvdy5jb21tYW5kbGluZS5zdGFydENvbW1hbmQgc3BsaXRbMV1cbiAgICAgICAgICAgICAgICB3aW5kb3cuY29tbWFuZGxpbmUuc2V0VGV4dCBzcGxpdFsyXVxuICAgICAgICAgICAgICAgIGNvbW1hbmQuZXhlY3V0ZSBzcGxpdFsyXVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICBmaWxlID0gaHJlZiArICc6JyArIHdpbmRvdy50ZXJtaW5hbC5wb3NGb3JFdmVudChldmVudClbMF1cbiAgICAgICAgICAgIHBvc3QuZW1pdCAnb3BlbkZpbGVzJywgW2ZpbGVdLCBuZXdUYWI6IGV2ZW50Lm1ldGFLZXlcblxuICAgICAgICAndW5oYW5kbGVkJ1xuXG4jICAwMDAwMDAwICAwMDAwMDAwMCAgIDAwMDAwMDAgICAwMDAwMDAwMCAgICAwMDAwMDAwICAwMDAgICAwMDAgIDAwMDAwMDAwICAwMDAwMDAwMCBcbiMgMDAwICAgICAgIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMFxuIyAwMDAwMDAwICAgMDAwMDAwMCAgIDAwMDAwMDAwMCAgMDAwMDAwMCAgICAwMDAgICAgICAgMDAwMDAwMDAwICAwMDAwMDAwICAgMDAwMDAwMCAgXG4jICAgICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDBcbiMgMDAwMDAwMCAgIDAwMDAwMDAwICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgIDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgIDAwMCAgIDAwMFxuXG5jbGFzcyBGaWxlU2VhcmNoZXIgZXh0ZW5kcyBzdHJlYW0uV3JpdGFibGVcbiAgICBcbiAgICBAOiAoQGNvbW1hbmQsIEBvcHQsIEBmaWxlKSAtPlxuICAgICAgICBcbiAgICAgICAgc3VwZXIoKVxuICAgICAgICBAbGluZSA9IDBcbiAgICAgICAgQGZsYWdzID0gJydcbiAgICAgICAgQHBhdHRlcm5zID0gc3dpdGNoIEBvcHQubmFtZVxuICAgICAgICAgICAgd2hlbiAnc2VhcmNoJyAgIHRoZW4gW1tuZXcgUmVnRXhwKF8uZXNjYXBlUmVnRXhwKEBvcHQudGV4dCksICdpJyksICdmb3VuZCddXVxuICAgICAgICAgICAgd2hlbiAnU2VhcmNoJyAgIHRoZW4gW1tuZXcgUmVnRXhwKF8uZXNjYXBlUmVnRXhwKEBvcHQudGV4dCkpLCAgICAgICdmb3VuZCddXVxuICAgICAgICAgICAgd2hlbiAnL3NlYXJjaC8nIHRoZW4gQGZsYWdzPSdpJzsgQG9wdC50ZXh0XG4gICAgICAgICAgICB3aGVuICcvU2VhcmNoLycgdGhlbiBAb3B0LnRleHRcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBrZXJyb3IgXCJjb21tYW5kcy9zZWFyY2ggRmlsZVNlYXJjaGVyIC0tIHVuaGFuZGxlZCAnI3tAb3B0Lm5hbWV9JyBjb21tYW5kOlwiLCBAY29tbWFuZC5uYW1lLCAnb3B0OicsIEBvcHQsICdmaWxlOicsIEBmaWxlXG4gICAgICAgICAgICAgICAgW1tuZXcgUmVnRXhwKF8uZXNjYXBlUmVnRXhwKEBvcHQudGV4dCksICdpJyksICdmb3VuZCddXVxuICAgICAgICAgICAgICAgIFxuICAgICAgICBAZm91bmQgPSBbXVxuICAgICAgICBleHRuID0gc2xhc2guZXh0IEBmaWxlXG4gICAgICAgIGlmIGV4dG4gaW4gU3ludGF4LnN5bnRheE5hbWVzXG4gICAgICAgICAgICBAc3ludGF4TmFtZSA9IGV4dG5cbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgQHN5bnRheE5hbWUgPSBudWxsXG4gICAgICAgICAgICBcbiAgICB3cml0ZTogKGNodW5rLCBlbmNvZGluZywgY2IpIC0+XG4gICAgICAgIFxuICAgICAgICBsaW5lcyA9IGNodW5rLnNwbGl0ICdcXG4nXG4gICAgICAgIEBzeW50YXhOYW1lID0gU3ludGF4LnNoZWJhbmcgbGluZXNbMF0gaWYgbm90IEBzeW50YXhOYW1lP1xuICAgICAgICBmb3IgbCBpbiBsaW5lc1xuICAgICAgICAgICAgQGxpbmUgKz0gMSAgICAgICAgICAgIFxuICAgICAgICAgICAgcm5ncyA9IG1hdGNoci5yYW5nZXMgQHBhdHRlcm5zLCBsLCBAZmxhZ3NcbiAgICAgICAgICAgIGlmIHJuZ3MubGVuZ3RoXG4gICAgICAgICAgICAgICAgQGZvdW5kLnB1c2ggW0BsaW5lLCBsLCBybmdzXVxuICAgICAgICB0cnVlXG4gICAgICAgIFxuICAgIGVuZDogKGNodW5rLCBlbmNvZGluZywgY2IpID0+XG4gICAgICAgIFxuICAgICAgICBpZiBAZm91bmQubGVuZ3RoXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRlcm1pbmFsID0gd2luZG93LnRlcm1pbmFsXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIG1ldGEgPSBcbiAgICAgICAgICAgICAgICBkaXNzOiAgU3ludGF4LmRpc3NGb3JUZXh0QW5kU3ludGF4IFwiI3tzbGFzaC50aWxkZSBAZmlsZX1cIiwgJ2tvJ1xuICAgICAgICAgICAgICAgIGhyZWY6ICBAZmlsZVxuICAgICAgICAgICAgICAgIGNsc3M6ICAnZ2l0SW5mb0ZpbGUnXG4gICAgICAgICAgICAgICAgY2xpY2s6IEBjb21tYW5kLm9uTWV0YUNsaWNrXG4gICAgICAgICAgICAgICAgbGluZTogICfil7wnXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB0ZXJtaW5hbC5hcHBlbmRNZXRhIG1ldGFcbiAgICAgICAgICAgIHRlcm1pbmFsLmFwcGVuZE1ldGEgY2xzczogJ3NwYWNlcidcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgZm9yIGZpIGluIFswLi4uQGZvdW5kLmxlbmd0aF1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBmID0gQGZvdW5kW2ZpXVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHN5dHggPSBuZXcgU3ludGF4IEBzeW50YXhOYW1lLCAoaSkgLT4gZlsxXVxuICAgICAgICAgICAgICAgIHN5dHguc2V0RmlsZVR5cGUgQHN5bnRheE5hbWVcbiAgICAgICAgICAgICAgICBkc3MgPSBzeXR4LmJhbGFuY2VyLmRpc3NGb3JMaW5lQW5kUmFuZ2VzIGZbMV0sIGZbMl1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbWV0YSA9XG4gICAgICAgICAgICAgICAgICAgIGRpc3M6IGRzc1xuICAgICAgICAgICAgICAgICAgICBocmVmOiBcIiN7QGZpbGV9OiN7ZlswXX1cIlxuICAgICAgICAgICAgICAgICAgICBjbHNzOiAnc2VhcmNoUmVzdWx0J1xuICAgICAgICAgICAgICAgICAgICBjbGljazogQGNvbW1hbmQub25NZXRhQ2xpY2tcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgZmkgYW5kIEBmb3VuZFtmaS0xXVswXSAhPSBmWzBdLTFcbiAgICAgICAgICAgICAgICAgICAgdGVybWluYWwuYXBwZW5kTWV0YSBjbHNzOiAnc3BhY2VyJ1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB0ZXJtaW5hbC5hcHBlbmRNZXRhIG1ldGFcbiAgICAgICAgICAgICAgICBwb3N0LmVtaXQgJ3NlYXJjaC1yZXN1bHQnLCBtZXRhXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB0ZXJtaW5hbC5hcHBlbmRNZXRhIGNsc3M6ICdzcGFjZXInXG4gICAgICAgICAgICB0ZXJtaW5hbC5zY3JvbGwuY3Vyc29yVG9Ub3AoKVxuICAgICAgICAgICAgICAgIFxubW9kdWxlLmV4cG9ydHMgPSBTZWFyY2hcbiJdfQ==
//# sourceURL=../../coffee/commands/search.coffee