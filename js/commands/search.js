// koffee 1.4.0

/*
 0000000  00000000   0000000   00000000    0000000  000   000
000       000       000   000  000   000  000       000   000
0000000   0000000   000000000  0000000    000       000000000
     000  000       000   000  000   000  000       000   000
0000000   00000000  000   000  000   000   0000000  000   000
 */
var Command, FileSearcher, Search, Syntax, _, fs, kerror, matchr, os, post, ref, slash, stream, walker,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty,
    indexOf = [].indexOf;

ref = require('kxk'), slash = ref.slash, post = ref.post, fs = ref.fs, os = ref.os, kerror = ref.kerror, _ = ref._;

matchr = require('../tools/matchr');

walker = require('../tools/walker');

Syntax = require('../editor/syntax');

Command = require('../commandline/command');

stream = require('stream');

Search = (function(superClass) {
    extend(Search, superClass);

    function Search(commandline) {
        this.onMetaClick = bind(this.onMetaClick, this);
        this.searchInFile = bind(this.searchInFile, this);
        Search.__super__.constructor.call(this, commandline);
        this.names = ["search", "Search", "/search/", "/Search/"];
    }

    Search.prototype.historyKey = function() {
        return this.name;
    };

    Search.prototype.execute = function(command) {
        var file, ref1, rngs;
        if (!command.length) {
            return;
        }
        switch (this.name) {
            case '/search/':
            case '/Search/':
                if (command === '^' || command === '$' || command === '.') {
                    return;
                }
                rngs = matchr.ranges(command, '  ');
                if (rngs.length === 2) {
                    return;
                }
        }
        command = Search.__super__.execute.call(this, command);
        file = (ref1 = window.editor.currentFile) != null ? ref1 : _.first(_.keys(post.get('indexer', 'files')));
        if (file == null) {
            return;
        }
        window.terminal.doAutoClear();
        this.startSearchInFiles({
            text: command,
            name: this.name,
            file: slash.path(file)
        });
        return {
            focus: 'terminal',
            show: 'terminal',
            text: command,
            select: true
        };
    };

    Search.prototype.startSearchInFiles = function(opt) {
        var dir, terminal;
        terminal = window.terminal;
        terminal.appendMeta({
            clss: 'searchHeader',
            diss: Syntax.dissForTextAndSyntax("▸ Search for '" + opt.text + "':", 'ko')
        });
        terminal.appendMeta({
            clss: 'spacer'
        });
        terminal.singleCursorAtPos([0, terminal.numLines() - 2]);
        dir = slash.pkg(slash.dir(opt.file));
        if (dir != null) {
            dir;
        } else {
            dir = slash.dir(opt.file);
        }
        this.walker = new walker({
            root: dir,
            maxDepth: 12,
            maxFiles: 5000,
            includeDirs: false,
            file: (function(_this) {
                return function(f, stat) {
                    return _this.searchInFile(opt, slash.path(f));
                };
            })(this)
        });
        this.walker.cfg.ignore.push('js');
        this.walker.cfg.ignore.push('lib');
        return this.walker.start();
    };

    Search.prototype.searchInFile = function(opt, file) {
        stream = fs.createReadStream(file, {
            encoding: 'utf8'
        });
        return stream.pipe(new FileSearcher(this, opt, file));
    };

    Search.prototype.onMetaClick = function(meta, event) {
        var command, file, href, split;
        href = meta[2].href;
        if (href.startsWith('>')) {
            split = href.split('>');
            if (window.commandline.commands[split[1]] != null) {
                command = window.commandline.commands[split[1]];
                window.commandline.startCommand(split[1]);
                window.commandline.setText(split[2]);
                command.execute(split[2]);
            }
        } else {
            file = href + ':' + window.terminal.posForEvent(event)[0];
            post.emit('openFiles', [file], {
                newTab: event.metaKey
            });
        }
        return 'unhandled';
    };

    return Search;

})(Command);

FileSearcher = (function(superClass) {
    extend(FileSearcher, superClass);

    function FileSearcher(command1, opt1, file1) {
        var extn;
        this.command = command1;
        this.opt = opt1;
        this.file = file1;
        this.end = bind(this.end, this);
        FileSearcher.__super__.constructor.call(this);
        this.line = 0;
        this.flags = '';
        this.patterns = (function() {
            switch (this.opt.name) {
                case 'search':
                    return [[new RegExp(_.escapeRegExp(this.opt.text), 'i'), 'found']];
                case 'Search':
                    return [[new RegExp(_.escapeRegExp(this.opt.text)), 'found']];
                case '/search/':
                    this.flags = 'i';
                    return this.opt.text;
                case '/Search/':
                    return this.opt.text;
                default:
                    kerror("commands/search FileSearcher -- unhandled '" + this.opt.name + "' command:", this.command.name, 'opt:', this.opt, 'file:', this.file);
                    return [[new RegExp(_.escapeRegExp(this.opt.text), 'i'), 'found']];
            }
        }).call(this);
        this.found = [];
        extn = slash.ext(this.file);
        if (indexOf.call(Syntax.syntaxNames, extn) >= 0) {
            this.syntaxName = extn;
        } else {
            this.syntaxName = null;
        }
    }

    FileSearcher.prototype.write = function(chunk, encoding, cb) {
        var j, l, len, lines, rngs;
        lines = chunk.split('\n');
        if (this.syntaxName == null) {
            this.syntaxName = Syntax.shebang(lines[0]);
        }
        for (j = 0, len = lines.length; j < len; j++) {
            l = lines[j];
            this.line += 1;
            rngs = matchr.ranges(this.patterns, l, this.flags);
            if (rngs.length) {
                this.found.push([this.line, l, rngs]);
            }
        }
        return true;
    };

    FileSearcher.prototype.end = function(chunk, encoding, cb) {
        var dss, f, fi, j, meta, ref1, sytx, terminal;
        if (this.found.length) {
            terminal = window.terminal;
            meta = {
                diss: Syntax.dissForTextAndSyntax("" + (slash.tilde(this.file)), 'ko'),
                href: this.file,
                clss: 'gitInfoFile',
                click: this.command.onMetaClick,
                line: '◼'
            };
            terminal.appendMeta(meta);
            terminal.appendMeta({
                clss: 'spacer'
            });
            for (fi = j = 0, ref1 = this.found.length; 0 <= ref1 ? j < ref1 : j > ref1; fi = 0 <= ref1 ? ++j : --j) {
                f = this.found[fi];
                sytx = new Syntax(this.syntaxName, function(i) {
                    return f[1];
                });
                sytx.setFileType(this.syntaxName);
                dss = sytx.balancer.dissForLineAndRanges(f[1], f[2]);
                meta = {
                    diss: dss,
                    href: this.file + ":" + f[0],
                    clss: 'searchResult',
                    click: this.command.onMetaClick
                };
                if (fi && this.found[fi - 1][0] !== f[0] - 1) {
                    terminal.appendMeta({
                        clss: 'spacer'
                    });
                }
                terminal.appendMeta(meta);
                post.emit('search-result', meta);
            }
            terminal.appendMeta({
                clss: 'spacer'
            });
            return terminal.scroll.cursorToTop();
        }
    };

    return FileSearcher;

})(stream.Writable);

module.exports = Search;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLmpzIiwic291cmNlUm9vdCI6Ii4iLCJzb3VyY2VzIjpbIiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7O0FBQUEsSUFBQSxrR0FBQTtJQUFBOzs7OztBQVFBLE1BQXFDLE9BQUEsQ0FBUSxLQUFSLENBQXJDLEVBQUUsaUJBQUYsRUFBUyxlQUFULEVBQWUsV0FBZixFQUFtQixXQUFuQixFQUF1QixtQkFBdkIsRUFBK0I7O0FBRS9CLE1BQUEsR0FBVSxPQUFBLENBQVEsaUJBQVI7O0FBQ1YsTUFBQSxHQUFVLE9BQUEsQ0FBUSxpQkFBUjs7QUFDVixNQUFBLEdBQVUsT0FBQSxDQUFRLGtCQUFSOztBQUNWLE9BQUEsR0FBVSxPQUFBLENBQVEsd0JBQVI7O0FBQ1YsTUFBQSxHQUFVLE9BQUEsQ0FBUSxRQUFSOztBQUVKOzs7SUFFQyxnQkFBQyxXQUFEOzs7UUFFQyx3Q0FBTSxXQUFOO1FBRUEsSUFBQyxDQUFBLEtBQUQsR0FBUyxDQUFDLFFBQUQsRUFBVyxRQUFYLEVBQXFCLFVBQXJCLEVBQWlDLFVBQWpDO0lBSlY7O3FCQU1ILFVBQUEsR0FBWSxTQUFBO2VBQUcsSUFBQyxDQUFBO0lBQUo7O3FCQVFaLE9BQUEsR0FBUyxTQUFDLE9BQUQ7QUFFTCxZQUFBO1FBQUEsSUFBVSxDQUFJLE9BQU8sQ0FBQyxNQUF0QjtBQUFBLG1CQUFBOztBQUVBLGdCQUFPLElBQUMsQ0FBQSxJQUFSO0FBQUEsaUJBQ1MsVUFEVDtBQUFBLGlCQUNxQixVQURyQjtnQkFFUSxJQUFHLE9BQUEsS0FBWSxHQUFaLElBQUEsT0FBQSxLQUFpQixHQUFqQixJQUFBLE9BQUEsS0FBc0IsR0FBekI7QUFDSSwyQkFESjs7Z0JBRUEsSUFBQSxHQUFPLE1BQU0sQ0FBQyxNQUFQLENBQWMsT0FBZCxFQUF1QixJQUF2QjtnQkFDUCxJQUFHLElBQUksQ0FBQyxNQUFMLEtBQWUsQ0FBbEI7QUFDSSwyQkFESjs7QUFMUjtRQVFBLE9BQUEsR0FBVSxvQ0FBTSxPQUFOO1FBQ1YsSUFB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RixHQUFPLEdBQVAsR0FBVSxDQUFFLENBQUEsQ0FBQSxDQURwQjtvQkFFQSxJQUFBLEVBQU0sY0FGTjtvQkFHQSxLQUFBLEVBQU8sSUFBQyxDQUFBLE9BQU8sQ0FBQyxXQUhoQjs7Z0JBS0osSUFBRyxFQUFBLElBQU8sSUFBQyxDQUFBLEtBQU0sQ0FBQSxFQUFBLEdBQUcsQ0FBSCxDQUFNLENBQUEsQ0FBQSxDQUFiLEtBQW1CLENBQUUsQ0FBQSxDQUFBLENBQUYsR0FBSyxDQUFsQztvQkFDSSxRQUFRLENBQUMsVUFBVCxDQUFvQjt3QkFBQSxJQUFBLEVBQU0sUUFBTjtxQkFBcEIsRUFESjs7Z0JBR0EsUUFBUSxDQUFDLFVBQVQsQ0FBb0IsSUFBcEI7Z0JBQ0EsSUFBSSxDQUFDLElBQUwsQ0FBVSxlQUFWLEVBQTJCLElBQTNCO0FBbEJKO1lBb0JBLFFBQVEsQ0FBQyxVQUFULENBQW9CO2dCQUFBLElBQUEsRUFBTSxRQUFOO2FBQXBCO21CQUNBLFFBQVEsQ0FBQyxNQUFNLENBQUMsV0FBaEIsQ0FBQSxFQW5DSjs7SUFGQzs7OztHQWxDa0IsTUFBTSxDQUFDOztBQXlFbEMsTUFBTSxDQUFDLE9BQVAsR0FBaUIiLCJzb3VyY2VzQ29udGVudCI6WyIjIyNcbiAwMDAwMDAwICAwMDAwMDAwMCAgIDAwMDAwMDAgICAwMDAwMDAwMCAgICAwMDAwMDAwICAwMDAgICAwMDBcbjAwMCAgICAgICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDBcbjAwMDAwMDAgICAwMDAwMDAwICAgMDAwMDAwMDAwICAwMDAwMDAwICAgIDAwMCAgICAgICAwMDAwMDAwMDBcbiAgICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDBcbjAwMDAwMDAgICAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAgICAwMDAgICAwMDAwMDAwICAwMDAgICAwMDBcbiMjI1xuXG57IHNsYXNoLCBwb3N0LCBmcywgb3MsIGtlcnJvciwgXyB9ID0gcmVxdWlyZSAna3hrJ1xuXG5tYXRjaHIgID0gcmVxdWlyZSAnLi4vdG9vbHMvbWF0Y2hyJ1xud2Fsa2VyICA9IHJlcXVpcmUgJy4uL3Rvb2xzL3dhbGtlcidcblN5bnRheCAgPSByZXF1aXJlICcuLi9lZGl0b3Ivc3ludGF4J1xuQ29tbWFuZCA9IHJlcXVpcmUgJy4uL2NvbW1hbmRsaW5lL2NvbW1hbmQnXG5zdHJlYW0gID0gcmVxdWlyZSAnc3RyZWFtJ1xuXG5jbGFzcyBTZWFyY2ggZXh0ZW5kcyBDb21tYW5kXG5cbiAgICBAOiAoY29tbWFuZGxpbmUpIC0+XG4gICAgICAgIFxuICAgICAgICBzdXBlciBjb21tYW5kbGluZVxuICAgICAgICBcbiAgICAgICAgQG5hbWVzID0gW1wic2VhcmNoXCIsIFwiU2VhcmNoXCIsIFwiL3NlYXJjaC9cIiwgXCIvU2VhcmNoL1wiXVxuICAgICBcbiAgICBoaXN0b3J5S2V5OiAtPiBAbmFtZVxuICAgICAgICAgICAgICAgIFxuICAgICMgMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgICAwMDAwMDAwICAwMDAgICAwMDAgIDAwMDAwMDAwMCAgMDAwMDAwMDBcbiAgICAjIDAwMCAgICAgICAgMDAwIDAwMCAgIDAwMCAgICAgICAwMDAgICAgICAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgICAgXG4gICAgIyAwMDAwMDAwICAgICAwMDAwMCAgICAwMDAwMDAwICAgMDAwICAgICAgIDAwMCAgIDAwMCAgICAgMDAwICAgICAwMDAwMDAwIFxuICAgICMgMDAwICAgICAgICAwMDAgMDAwICAgMDAwICAgICAgIDAwMCAgICAgICAwMDAgICAwMDAgICAgIDAwMCAgICAgMDAwICAgICBcbiAgICAjIDAwMDAwMDAwICAwMDAgICAwMDAgIDAwMDAwMDAwICAgMDAwMDAwMCAgIDAwMDAwMDAgICAgICAwMDAgICAgIDAwMDAwMDAwXG4gICAgXG4gICAgZXhlY3V0ZTogKGNvbW1hbmQpIC0+XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gaWYgbm90IGNvbW1hbmQubGVuZ3RoXG4gICAgICAgIFxuICAgICAgICBzd2l0Y2ggQG5hbWVcbiAgICAgICAgICAgIHdoZW4gJy9zZWFyY2gvJywgJy9TZWFyY2gvJ1xuICAgICAgICAgICAgICAgIGlmIGNvbW1hbmQgaW4gWydeJywgJyQnLCAnLiddXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcbiAgICAgICAgICAgICAgICBybmdzID0gbWF0Y2hyLnJhbmdlcyBjb21tYW5kLCAnICAnXG4gICAgICAgICAgICAgICAgaWYgcm5ncy5sZW5ndGggPT0gMlxuICAgICAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgY29tbWFuZCA9IHN1cGVyIGNvbW1hbmRcbiAgICAgICAgZmlsZSA9IHdpbmRvdy5lZGl0b3IuY3VycmVudEZpbGUgPyBfLmZpcnN0IF8ua2V5cyhwb3N0LmdldCgnaW5kZXhlcicsICdmaWxlcycpKVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGlmIG5vdCBmaWxlP1xuICAgICAgICBcbiAgICAgICAgd2luZG93LnRlcm1pbmFsLmRvQXV0b0NsZWFyKClcbiAgICAgICAgXG4gICAgICAgIEBzdGFydFNlYXJjaEluRmlsZXMgXG4gICAgICAgICAgICB0ZXh0OiBjb21tYW5kXG4gICAgICAgICAgICBuYW1lOiBAbmFtZVxuICAgICAgICAgICAgZmlsZTogc2xhc2gucGF0aCBmaWxlXG4gICAgICAgICAgICBcbiAgICAgICAgZm9jdXM6ICAndGVybWluYWwnXG4gICAgICAgIHNob3c6ICAgJ3Rlcm1pbmFsJ1xuICAgICAgICB0ZXh0OiAgIGNvbW1hbmRcbiAgICAgICAgc2VsZWN0OiB0cnVlXG4gICAgICBcbiAgICAjICAwMDAwMDAwICAwMDAwMDAwMCAgIDAwMDAwMDAgICAwMDAwMDAwMCAgICAwMDAwMDAwICAwMDAgICAwMDBcbiAgICAjIDAwMCAgICAgICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDBcbiAgICAjIDAwMDAwMDAgICAwMDAwMDAwICAgMDAwMDAwMDAwICAwMDAwMDAwICAgIDAwMCAgICAgICAwMDAwMDAwMDBcbiAgICAjICAgICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDBcbiAgICAjIDAwMDAwMDAgICAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAgICAwMDAgICAwMDAwMDAwICAwMDAgICAwMDBcbiAgICBcbiAgICBzdGFydFNlYXJjaEluRmlsZXM6IChvcHQpIC0+XG4gICAgICAgIFxuICAgICAgICB0ZXJtaW5hbCA9IHdpbmRvdy50ZXJtaW5hbFxuICAgICAgICAjIHRlcm1pbmFsLmFwcGVuZE1ldGEgY2xzczogJ3NhbHQnLCB0ZXh0OiBvcHQudGV4dC5zbGljZSAwLCAxNFxuICAgICAgICB0ZXJtaW5hbC5hcHBlbmRNZXRhIGNsc3M6J3NlYXJjaEhlYWRlcicsIGRpc3M6U3ludGF4LmRpc3NGb3JUZXh0QW5kU3ludGF4IFwi4pa4IFNlYXJjaCBmb3IgJyN7b3B0LnRleHR9JzpcIiwgJ2tvJ1xuICAgICAgICB0ZXJtaW5hbC5hcHBlbmRNZXRhIGNsc3M6J3NwYWNlcidcbiAgICAgICAgdGVybWluYWwuc2luZ2xlQ3Vyc29yQXRQb3MgWzAsIHRlcm1pbmFsLm51bUxpbmVzKCktMl1cbiAgICAgICAgZGlyID0gc2xhc2gucGtnIHNsYXNoLmRpciBvcHQuZmlsZVxuICAgICAgICBkaXIgPz0gc2xhc2guZGlyIG9wdC5maWxlXG4gICAgICAgIEB3YWxrZXIgPSBuZXcgd2Fsa2VyXG4gICAgICAgICAgICByb290OiAgICAgICAgZGlyXG4gICAgICAgICAgICBtYXhEZXB0aDogICAgMTJcbiAgICAgICAgICAgIG1heEZpbGVzOiAgICA1MDAwXG4gICAgICAgICAgICBpbmNsdWRlRGlyczogZmFsc2VcbiAgICAgICAgICAgIGZpbGU6ICAgICAgICAoZixzdGF0KSA9PiBAc2VhcmNoSW5GaWxlIG9wdCwgc2xhc2gucGF0aCBmXG4gICAgICAgIEB3YWxrZXIuY2ZnLmlnbm9yZS5wdXNoICdqcycgICMgdGhlc2UgZGlyZWN0b3JpZXMgYXJlIG5vdCBpbmNsdWRlZCBpbiBzZWFyY2ggcmVzdWx0c1xuICAgICAgICBAd2Fsa2VyLmNmZy5pZ25vcmUucHVzaCAnbGliJyAjIHRoZXkgc2hvdWxkIGJlIGNvbmZpZ3VyYWJsZSwgbWF5YmUgaW4gcGFja2FnZS5ub29uIG9yIC5rb25yYWQubm9vbj9cbiAgICAgICAgQHdhbGtlci5zdGFydCgpXG4gICAgICAgIFxuICAgIHNlYXJjaEluRmlsZTogKG9wdCwgZmlsZSkgPT5cblxuICAgICAgICBzdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtIGZpbGUsIGVuY29kaW5nOiAndXRmOCdcbiAgICAgICAgc3RyZWFtLnBpcGUgbmV3IEZpbGVTZWFyY2hlciBALCBvcHQsIGZpbGVcblxuICAgICMgMDAgICAgIDAwICAwMDAwMDAwMCAgMDAwMDAwMDAwICAgMDAwMDAwMCAgICAwMDAwMDAwICAwMDAgICAgICAwMDAgICAwMDAwMDAwICAwMDAgICAwMDAgIFxuICAgICMgMDAwICAgMDAwICAwMDAgICAgICAgICAgMDAwICAgICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAgICAwMDAgIDAwMCAgICAgICAwMDAgIDAwMCAgIFxuICAgICMgMDAwMDAwMDAwICAwMDAwMDAwICAgICAgMDAwICAgICAwMDAwMDAwMDAgIDAwMCAgICAgICAwMDAgICAgICAwMDAgIDAwMCAgICAgICAwMDAwMDAwICAgIFxuICAgICMgMDAwIDAgMDAwICAwMDAgICAgICAgICAgMDAwICAgICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAgICAwMDAgIDAwMCAgICAgICAwMDAgIDAwMCAgIFxuICAgICMgMDAwICAgMDAwICAwMDAwMDAwMCAgICAgMDAwICAgICAwMDAgICAwMDAgICAwMDAwMDAwICAwMDAwMDAwICAwMDAgICAwMDAwMDAwICAwMDAgICAwMDAgIFxuICAgIFxuICAgIG9uTWV0YUNsaWNrOiAobWV0YSwgZXZlbnQpID0+XG5cbiAgICAgICAgaHJlZiA9IG1ldGFbMl0uaHJlZiAgIFxuICAgICAgICBcbiAgICAgICAgaWYgaHJlZi5zdGFydHNXaXRoICc+J1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBzcGxpdCA9IGhyZWYuc3BsaXQgJz4nXG4gICAgICAgICAgICBpZiB3aW5kb3cuY29tbWFuZGxpbmUuY29tbWFuZHNbc3BsaXRbMV1dP1xuICAgICAgICAgICAgICAgIGNvbW1hbmQgPSB3aW5kb3cuY29tbWFuZGxpbmUuY29tbWFuZHNbc3BsaXRbMV1dXG4gICAgICAgICAgICAgICAgd2luZG93LmNvbW1hbmRsaW5lLnN0YXJ0Q29tbWFuZCBzcGxpdFsxXVxuICAgICAgICAgICAgICAgIHdpbmRvdy5jb21tYW5kbGluZS5zZXRUZXh0IHNwbGl0WzJdXG4gICAgICAgICAgICAgICAgY29tbWFuZC5leGVjdXRlIHNwbGl0WzJdXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGZpbGUgPSBocmVmICsgJzonICsgd2luZG93LnRlcm1pbmFsLnBvc0ZvckV2ZW50KGV2ZW50KVswXVxuICAgICAgICAgICAgcG9zdC5lbWl0ICdvcGVuRmlsZXMnLCBbZmlsZV0sIG5ld1RhYjogZXZlbnQubWV0YUtleVxuXG4gICAgICAgICd1bmhhbmRsZWQnXG5cbiMgIDAwMDAwMDAgIDAwMDAwMDAwICAgMDAwMDAwMCAgIDAwMDAwMDAwICAgIDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgIDAwMDAwMDAwIFxuIyAwMDAgICAgICAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwXG4jIDAwMDAwMDAgICAwMDAwMDAwICAgMDAwMDAwMDAwICAwMDAwMDAwICAgIDAwMCAgICAgICAwMDAwMDAwMDAgIDAwMDAwMDAgICAwMDAwMDAwICBcbiMgICAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMFxuIyAwMDAwMDAwICAgMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAgMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMCAgMDAwICAgMDAwXG5cbmNsYXNzIEZpbGVTZWFyY2hlciBleHRlbmRzIHN0cmVhbS5Xcml0YWJsZVxuICAgIFxuICAgIEA6IChAY29tbWFuZCwgQG9wdCwgQGZpbGUpIC0+XG4gICAgICAgIFxuICAgICAgICBzdXBlcigpXG4gICAgICAgIEBsaW5lID0gMFxuICAgICAgICBAZmxhZ3MgPSAnJ1xuICAgICAgICBAcGF0dGVybnMgPSBzd2l0Y2ggQG9wdC5uYW1lXG4gICAgICAgICAgICB3aGVuICdzZWFyY2gnICAgdGhlbiBbW25ldyBSZWdFeHAoXy5lc2NhcGVSZWdFeHAoQG9wdC50ZXh0KSwgJ2knKSwgJ2ZvdW5kJ11dXG4gICAgICAgICAgICB3aGVuICdTZWFyY2gnICAgdGhlbiBbW25ldyBSZWdFeHAoXy5lc2NhcGVSZWdFeHAoQG9wdC50ZXh0KSksICAgICAgJ2ZvdW5kJ11dXG4gICAgICAgICAgICB3aGVuICcvc2VhcmNoLycgdGhlbiBAZmxhZ3M9J2knOyBAb3B0LnRleHRcbiAgICAgICAgICAgIHdoZW4gJy9TZWFyY2gvJyB0aGVuIEBvcHQudGV4dFxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIGtlcnJvciBcImNvbW1hbmRzL3NlYXJjaCBGaWxlU2VhcmNoZXIgLS0gdW5oYW5kbGVkICcje0BvcHQubmFtZX0nIGNvbW1hbmQ6XCIsIEBjb21tYW5kLm5hbWUsICdvcHQ6JywgQG9wdCwgJ2ZpbGU6JywgQGZpbGVcbiAgICAgICAgICAgICAgICBbW25ldyBSZWdFeHAoXy5lc2NhcGVSZWdFeHAoQG9wdC50ZXh0KSwgJ2knKSwgJ2ZvdW5kJ11dXG4gICAgICAgICAgICAgICAgXG4gICAgICAgIEBmb3VuZCA9IFtdXG4gICAgICAgIGV4dG4gPSBzbGFzaC5leHQgQGZpbGVcbiAgICAgICAgaWYgZXh0biBpbiBTeW50YXguc3ludGF4TmFtZXNcbiAgICAgICAgICAgIEBzeW50YXhOYW1lID0gZXh0blxuICAgICAgICBlbHNlXG4gICAgICAgICAgICBAc3ludGF4TmFtZSA9IG51bGxcbiAgICAgICAgICAgIFxuICAgIHdyaXRlOiAoY2h1bmssIGVuY29kaW5nLCBjYikgLT5cbiAgICAgICAgXG4gICAgICAgIGxpbmVzID0gY2h1bmsuc3BsaXQgJ1xcbidcbiAgICAgICAgQHN5bnRheE5hbWUgPSBTeW50YXguc2hlYmFuZyBsaW5lc1swXSBpZiBub3QgQHN5bnRheE5hbWU/XG4gICAgICAgIGZvciBsIGluIGxpbmVzXG4gICAgICAgICAgICBAbGluZSArPSAxICAgICAgICAgICAgXG4gICAgICAgICAgICBybmdzID0gbWF0Y2hyLnJhbmdlcyBAcGF0dGVybnMsIGwsIEBmbGFnc1xuICAgICAgICAgICAgaWYgcm5ncy5sZW5ndGhcbiAgICAgICAgICAgICAgICBAZm91bmQucHVzaCBbQGxpbmUsIGwsIHJuZ3NdXG4gICAgICAgIHRydWVcbiAgICAgICAgXG4gICAgZW5kOiAoY2h1bmssIGVuY29kaW5nLCBjYikgPT5cbiAgICAgICAgXG4gICAgICAgIGlmIEBmb3VuZC5sZW5ndGhcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGVybWluYWwgPSB3aW5kb3cudGVybWluYWxcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbWV0YSA9IFxuICAgICAgICAgICAgICAgIGRpc3M6ICBTeW50YXguZGlzc0ZvclRleHRBbmRTeW50YXggXCIje3NsYXNoLnRpbGRlIEBmaWxlfVwiLCAna28nXG4gICAgICAgICAgICAgICAgaHJlZjogIEBmaWxlXG4gICAgICAgICAgICAgICAgY2xzczogICdnaXRJbmZvRmlsZSdcbiAgICAgICAgICAgICAgICBjbGljazogQGNvbW1hbmQub25NZXRhQ2xpY2tcbiAgICAgICAgICAgICAgICBsaW5lOiAgJ+KXvCdcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIHRlcm1pbmFsLmFwcGVuZE1ldGEgbWV0YVxuICAgICAgICAgICAgdGVybWluYWwuYXBwZW5kTWV0YSBjbHNzOiAnc3BhY2VyJ1xuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBmb3IgZmkgaW4gWzAuLi5AZm91bmQubGVuZ3RoXVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGYgPSBAZm91bmRbZmldXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgc3l0eCA9IG5ldyBTeW50YXggQHN5bnRheE5hbWUsIChpKSAtPiBmWzFdXG4gICAgICAgICAgICAgICAgc3l0eC5zZXRGaWxlVHlwZSBAc3ludGF4TmFtZVxuICAgICAgICAgICAgICAgIGRzcyA9IHN5dHguYmFsYW5jZXIuZGlzc0ZvckxpbmVBbmRSYW5nZXMgZlsxXSwgZlsyXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBtZXRhID1cbiAgICAgICAgICAgICAgICAgICAgZGlzczogZHNzXG4gICAgICAgICAgICAgICAgICAgIGhyZWY6IFwiI3tAZmlsZX06I3tmWzBdfVwiXG4gICAgICAgICAgICAgICAgICAgIGNsc3M6ICdzZWFyY2hSZXN1bHQnXG4gICAgICAgICAgICAgICAgICAgIGNsaWNrOiBAY29tbWFuZC5vbk1ldGFDbGlja1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiBmaSBhbmQgQGZvdW5kW2ZpLTFdWzBdICE9IGZbMF0tMVxuICAgICAgICAgICAgICAgICAgICB0ZXJtaW5hbC5hcHBlbmRNZXRhIGNsc3M6ICdzcGFjZXInXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRlcm1pbmFsLmFwcGVuZE1ldGEgbWV0YVxuICAgICAgICAgICAgICAgIHBvc3QuZW1pdCAnc2VhcmNoLXJlc3VsdCcsIG1ldGFcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIHRlcm1pbmFsLmFwcGVuZE1ldGEgY2xzczogJ3NwYWNlcidcbiAgICAgICAgICAgIHRlcm1pbmFsLnNjcm9sbC5jdXJzb3JUb1RvcCgpXG4gICAgICAgICAgICAgICAgXG5tb2R1bGUuZXhwb3J0cyA9IFNlYXJjaFxuIl19
//# sourceURL=../../coffee/commands/search.coffee