// koffee 1.4.0

/*
 0000000  000000000   0000000   000000000  000   000   0000000  
000          000     000   000     000     000   000  000       
0000000      000     000000000     000     000   000  0000000   
     000     000     000   000     000     000   000       000  
0000000      000     000   000     000      0000000   0000000
 */
var _, childp, dir, empty, gitCmd, gitOpt, parseResult, ref, slash, status, str, valid;

ref = require('kxk'), childp = ref.childp, valid = ref.valid, empty = ref.empty, slash = ref.slash, str = ref.str, _ = ref._;

gitCmd = 'git status --porcelain';

gitOpt = function(gitDir) {
    return {
        encoding: 'utf8',
        cwd: slash.unslash(gitDir),
        stdio: ['pipe', 'pipe', 'ignore']
    };
};

status = function(gitDir, cb) {
    var err, r;
    if (_.isFunction(cb)) {
        if (empty(gitDir)) {
            return cb({});
        } else {
            try {
                return childp.exec(gitCmd, gitOpt(gitDir), function(err, r) {
                    if (valid(err)) {
                        return cb({});
                    } else {
                        return cb(parseResult(gitDir, r));
                    }
                });
            } catch (error) {
                err = error;
                return cb({});
            }
        }
    } else {
        if (empty(gitDir)) {
            return {};
        }
        try {
            r = childp.execSync(gitCmd, gitOpt(gitDir));
        } catch (error) {
            err = error;
            return {};
        }
        return parseResult(gitDir, r);
    }
};

parseResult = function(gitDir, result) {
    var dirSet, file, header, info, line, lines, rel;
    if (result.startsWith('fatal:')) {
        return {};
    }
    lines = result.split('\n');
    info = {
        gitDir: gitDir,
        changed: [],
        deleted: [],
        added: []
    };
    dirSet = new Set;
    while (line = lines.shift()) {
        rel = line.slice(3);
        file = slash.join(gitDir, line.slice(3));
        while ((rel = slash.dir(rel)) !== '') {
            dirSet.add(rel);
        }
        header = line.slice(0, 2);
        switch (header) {
            case ' D':
                info.deleted.push(file);
                break;
            case ' M':
                info.changed.push(file);
                break;
            case '??':
                info.added.push(file);
        }
    }
    info.dirs = Array.from(dirSet).map(function(d) {
        return slash.join(gitDir, d);
    });
    return info;
};

if (module.parent) {
    module.exports = status;
} else {
    if (!empty(process.argv[2])) {
        dir = slash.resolve(process.argv[2]);
    } else {
        dir = process.cwd();
    }
    console.log(status(dir));
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdHVzLmpzIiwic291cmNlUm9vdCI6Ii4iLCJzb3VyY2VzIjpbIiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7O0FBQUEsSUFBQTs7QUFRQSxNQUEwQyxPQUFBLENBQVEsS0FBUixDQUExQyxFQUFFLG1CQUFGLEVBQVUsaUJBQVYsRUFBaUIsaUJBQWpCLEVBQXdCLGlCQUF4QixFQUErQixhQUEvQixFQUFvQzs7QUFFcEMsTUFBQSxHQUFTOztBQUNULE1BQUEsR0FBUyxTQUFDLE1BQUQ7V0FBWTtRQUFBLFFBQUEsRUFBVSxNQUFWO1FBQWlCLEdBQUEsRUFBSyxLQUFLLENBQUMsT0FBTixDQUFjLE1BQWQsQ0FBdEI7UUFBNkMsS0FBQSxFQUFNLENBQUMsTUFBRCxFQUFRLE1BQVIsRUFBZSxRQUFmLENBQW5EOztBQUFaOztBQUVULE1BQUEsR0FBUyxTQUFDLE1BQUQsRUFBUyxFQUFUO0FBRUwsUUFBQTtJQUFBLElBQUcsQ0FBQyxDQUFDLFVBQUYsQ0FBYSxFQUFiLENBQUg7UUFFSSxJQUFHLEtBQUEsQ0FBTSxNQUFOLENBQUg7bUJBQ0ksRUFBQSxDQUFHLEVBQUgsRUFESjtTQUFBLE1BQUE7QUFHSTt1QkFDSSxNQUFNLENBQUMsSUFBUCxDQUFZLE1BQVosRUFBb0IsTUFBQSxDQUFPLE1BQVAsQ0FBcEIsRUFBb0MsU0FBQyxHQUFELEVBQUssQ0FBTDtvQkFDaEMsSUFBRyxLQUFBLENBQU0sR0FBTixDQUFIOytCQUNJLEVBQUEsQ0FBRyxFQUFILEVBREo7cUJBQUEsTUFBQTsrQkFHSSxFQUFBLENBQUcsV0FBQSxDQUFZLE1BQVosRUFBb0IsQ0FBcEIsQ0FBSCxFQUhKOztnQkFEZ0MsQ0FBcEMsRUFESjthQUFBLGFBQUE7Z0JBTU07dUJBQ0YsRUFBQSxDQUFHLEVBQUgsRUFQSjthQUhKO1NBRko7S0FBQSxNQUFBO1FBY0ksSUFBYSxLQUFBLENBQU0sTUFBTixDQUFiO0FBQUEsbUJBQU8sR0FBUDs7QUFDQTtZQUNJLENBQUEsR0FBSSxNQUFNLENBQUMsUUFBUCxDQUFnQixNQUFoQixFQUF3QixNQUFBLENBQU8sTUFBUCxDQUF4QixFQURSO1NBQUEsYUFBQTtZQUVNO0FBQ0YsbUJBQU8sR0FIWDs7ZUFLQSxXQUFBLENBQVksTUFBWixFQUFvQixDQUFwQixFQXBCSjs7QUFGSzs7QUE4QlQsV0FBQSxHQUFjLFNBQUMsTUFBRCxFQUFTLE1BQVQ7QUFFVixRQUFBO0lBQUEsSUFBRyxNQUFNLENBQUMsVUFBUCxDQUFrQixRQUFsQixDQUFIO0FBQW1DLGVBQU8sR0FBMUM7O0lBRUEsS0FBQSxHQUFRLE1BQU0sQ0FBQyxLQUFQLENBQWEsSUFBYjtJQUVSLElBQUEsR0FDSTtRQUFBLE1BQUEsRUFBUyxNQUFUO1FBQ0EsT0FBQSxFQUFTLEVBRFQ7UUFFQSxPQUFBLEVBQVMsRUFGVDtRQUdBLEtBQUEsRUFBUyxFQUhUOztJQUtKLE1BQUEsR0FBUyxJQUFJO0FBRWIsV0FBTSxJQUFBLEdBQU8sS0FBSyxDQUFDLEtBQU4sQ0FBQSxDQUFiO1FBQ0ksR0FBQSxHQUFTLElBQUksQ0FBQyxLQUFMLENBQVcsQ0FBWDtRQUNULElBQUEsR0FBUyxLQUFLLENBQUMsSUFBTixDQUFXLE1BQVgsRUFBbUIsSUFBSSxDQUFDLEtBQUwsQ0FBVyxDQUFYLENBQW5CO0FBQ1QsZUFBTSxDQUFDLEdBQUEsR0FBTSxLQUFLLENBQUMsR0FBTixDQUFVLEdBQVYsQ0FBUCxDQUFBLEtBQXlCLEVBQS9CO1lBQ0ksTUFBTSxDQUFDLEdBQVAsQ0FBVyxHQUFYO1FBREo7UUFHQSxNQUFBLEdBQVMsSUFBSSxDQUFDLEtBQUwsQ0FBVyxDQUFYLEVBQWEsQ0FBYjtBQUNULGdCQUFPLE1BQVA7QUFBQSxpQkFDUyxJQURUO2dCQUNtQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQWIsQ0FBa0IsSUFBbEI7QUFBVjtBQURULGlCQUVTLElBRlQ7Z0JBRW1CLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBYixDQUFrQixJQUFsQjtBQUFWO0FBRlQsaUJBR1MsSUFIVDtnQkFHbUIsSUFBSSxDQUFDLEtBQU8sQ0FBQyxJQUFiLENBQWtCLElBQWxCO0FBSG5CO0lBUEo7SUFZQSxJQUFJLENBQUMsSUFBTCxHQUFZLEtBQUssQ0FBQyxJQUFOLENBQVcsTUFBWCxDQUFrQixDQUFDLEdBQW5CLENBQXVCLFNBQUMsQ0FBRDtlQUFPLEtBQUssQ0FBQyxJQUFOLENBQVcsTUFBWCxFQUFtQixDQUFuQjtJQUFQLENBQXZCO1dBQ1o7QUEzQlU7O0FBbUNkLElBQUcsTUFBTSxDQUFDLE1BQVY7SUFFSSxNQUFNLENBQUMsT0FBUCxHQUFpQixPQUZyQjtDQUFBLE1BQUE7SUFLSSxJQUFHLENBQUksS0FBQSxDQUFNLE9BQU8sQ0FBQyxJQUFLLENBQUEsQ0FBQSxDQUFuQixDQUFQO1FBQ0ksR0FBQSxHQUFNLEtBQUssQ0FBQyxPQUFOLENBQWMsT0FBTyxDQUFDLElBQUssQ0FBQSxDQUFBLENBQTNCLEVBRFY7S0FBQSxNQUFBO1FBR0ksR0FBQSxHQUFNLE9BQU8sQ0FBQyxHQUFSLENBQUEsRUFIVjs7SUFLQSxPQUFBLENBQUEsR0FBQSxDQUFJLE1BQUEsQ0FBTyxHQUFQLENBQUosRUFWSiIsInNvdXJjZXNDb250ZW50IjpbIiMjI1xuIDAwMDAwMDAgIDAwMDAwMDAwMCAgIDAwMDAwMDAgICAwMDAwMDAwMDAgIDAwMCAgIDAwMCAgIDAwMDAwMDAgIFxuMDAwICAgICAgICAgIDAwMCAgICAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgIDAwMCAgMDAwICAgICAgIFxuMDAwMDAwMCAgICAgIDAwMCAgICAgMDAwMDAwMDAwICAgICAwMDAgICAgIDAwMCAgIDAwMCAgMDAwMDAwMCAgIFxuICAgICAwMDAgICAgIDAwMCAgICAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgIDAwMCAgICAgICAwMDAgIFxuMDAwMDAwMCAgICAgIDAwMCAgICAgMDAwICAgMDAwICAgICAwMDAgICAgICAwMDAwMDAwICAgMDAwMDAwMCAgIFxuIyMjXG5cbnsgY2hpbGRwLCB2YWxpZCwgZW1wdHksIHNsYXNoLCBzdHIsIF8gfSA9IHJlcXVpcmUgJ2t4aydcblxuZ2l0Q21kID0gJ2dpdCBzdGF0dXMgLS1wb3JjZWxhaW4nXG5naXRPcHQgPSAoZ2l0RGlyKSAtPiBlbmNvZGluZzrCoCd1dGY4JyBjd2Q6IHNsYXNoLnVuc2xhc2goZ2l0RGlyKSwgc3RkaW86WydwaXBlJyAncGlwZScgJ2lnbm9yZSddXG5cbnN0YXR1cyA9IChnaXREaXIsIGNiKSAtPlxuXG4gICAgaWYgXy5pc0Z1bmN0aW9uIGNiXG4gICAgICAgIFxuICAgICAgICBpZiBlbXB0eSBnaXREaXJcbiAgICAgICAgICAgIGNiIHt9XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHRyeVxuICAgICAgICAgICAgICAgIGNoaWxkcC5leGVjIGdpdENtZCwgZ2l0T3B0KGdpdERpciksIChlcnIscikgLT5cbiAgICAgICAgICAgICAgICAgICAgaWYgdmFsaWQgZXJyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYiB7fVxuICAgICAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICBjYiBwYXJzZVJlc3VsdCBnaXREaXIsIHJcbiAgICAgICAgICAgIGNhdGNoIGVyclxuICAgICAgICAgICAgICAgIGNiIHt9XG4gICAgZWxzZVxuICAgICAgICByZXR1cm4ge30gaWYgZW1wdHkgZ2l0RGlyXG4gICAgICAgIHRyeVxuICAgICAgICAgICAgciA9IGNoaWxkcC5leGVjU3luYyBnaXRDbWQsIGdpdE9wdCBnaXREaXJcbiAgICAgICAgY2F0Y2ggZXJyXG4gICAgICAgICAgICByZXR1cm4ge31cbiAgICAgICAgXG4gICAgICAgIHBhcnNlUmVzdWx0IGdpdERpciwgclxuICAgIFxuIyAwMDAwMDAwMCAgICAwMDAwMDAwICAgMDAwMDAwMDAgICAgMDAwMDAwMCAgMDAwMDAwMDAgIFxuIyAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgICAgIFxuIyAwMDAwMDAwMCAgIDAwMDAwMDAwMCAgMDAwMDAwMCAgICAwMDAwMDAwICAgMDAwMDAwMCAgIFxuIyAwMDAgICAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAgICAgIDAwMCAgMDAwICAgICAgIFxuIyAwMDAgICAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAwMDAwICAgMDAwMDAwMDAgIFxuXG5wYXJzZVJlc3VsdCA9IChnaXREaXIsIHJlc3VsdCkgLT5cbiAgICBcbiAgICBpZiByZXN1bHQuc3RhcnRzV2l0aCAnZmF0YWw6JyB0aGVuIHJldHVybiB7fVxuICAgIFxuICAgIGxpbmVzID0gcmVzdWx0LnNwbGl0ICdcXG4nXG5cbiAgICBpbmZvID0gXG4gICAgICAgIGdpdERpcjogIGdpdERpclxuICAgICAgICBjaGFuZ2VkOiBbXVxuICAgICAgICBkZWxldGVkOiBbXVxuICAgICAgICBhZGRlZDogICBbXVxuICAgICAgICBcbiAgICBkaXJTZXQgPSBuZXcgU2V0XG4gICAgXG4gICAgd2hpbGUgbGluZSA9IGxpbmVzLnNoaWZ0KClcbiAgICAgICAgcmVsICAgID0gbGluZS5zbGljZSAzXG4gICAgICAgIGZpbGUgICA9IHNsYXNoLmpvaW4gZ2l0RGlyLCBsaW5lLnNsaWNlIDNcbiAgICAgICAgd2hpbGUgKHJlbCA9IHNsYXNoLmRpciByZWwpICE9ICcnXG4gICAgICAgICAgICBkaXJTZXQuYWRkIHJlbFxuICAgICAgICAgICAgXG4gICAgICAgIGhlYWRlciA9IGxpbmUuc2xpY2UgMCwyXG4gICAgICAgIHN3aXRjaCBoZWFkZXJcbiAgICAgICAgICAgIHdoZW4gJyBEJyB0aGVuIGluZm8uZGVsZXRlZC5wdXNoIGZpbGVcbiAgICAgICAgICAgIHdoZW4gJyBNJyB0aGVuIGluZm8uY2hhbmdlZC5wdXNoIGZpbGVcbiAgICAgICAgICAgIHdoZW4gJz8/JyB0aGVuIGluZm8uYWRkZWQgIC5wdXNoIGZpbGVcbiAgICAgICAgICAgIFxuICAgIGluZm8uZGlycyA9IEFycmF5LmZyb20oZGlyU2V0KS5tYXAgKGQpIC0+IHNsYXNoLmpvaW4gZ2l0RGlyLCBkXG4gICAgaW5mb1xuXG4jIDAwICAgICAwMCAgIDAwMDAwMDAgICAwMDAwMDAwICAgIDAwMCAgIDAwMCAgMDAwICAgICAgMDAwMDAwMDAgIFxuIyAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgICAgIDAwMCAgICAgICBcbiMgMDAwMDAwMDAwICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAwMDAwMDAwICAgXG4jIDAwMCAwIDAwMCAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgMDAwICAgICAgIFxuIyAwMDAgICAwMDAgICAwMDAwMDAwICAgMDAwMDAwMCAgICAgMDAwMDAwMCAgIDAwMDAwMDAgIDAwMDAwMDAwICBcblxuaWYgbW9kdWxlLnBhcmVudFxuICAgIFxuICAgIG1vZHVsZS5leHBvcnRzID0gc3RhdHVzXG4gICAgXG5lbHNlXG4gICAgaWYgbm90IGVtcHR5IHByb2Nlc3MuYXJndlsyXVxuICAgICAgICBkaXIgPSBzbGFzaC5yZXNvbHZlIHByb2Nlc3MuYXJndlsyXVxuICAgIGVsc2VcbiAgICAgICAgZGlyID0gcHJvY2Vzcy5jd2QoKVxuICAgIFxuICAgIGxvZyBzdGF0dXMgZGlyXG4gICAgIl19
//# sourceURL=../../coffee/git/status.coffee